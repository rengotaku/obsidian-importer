# Feature Specification: argos-translate の導入

**Feature Branch**: `053-argos-translate-integration`
**Created**: 2026-02-16
**Status**: Rejected
**Input**: User description: "LLMに翻訳している箇所をライブラリに変更する。https://github.com/argosopentech/argos-translate"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本的な英日翻訳 (Priority: P1)

ユーザーが会話データをインポートする際、英語のサマリーが自動的に日本語に翻訳される。現在LLM（Ollama）で行っている翻訳処理を、argos-translate ライブラリに置き換え、オフラインで高速に翻訳を実行する。

**Why this priority**: 翻訳機能はコア要件であり、現行のLLM翻訳からの移行において最も基本的かつ必須の機能。LLMへの依存を減らしコストと処理時間を削減する。

**Independent Test**: 英語テキストを入力して日本語翻訳結果を検証することで、単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 英語のサマリーテキストがある場合, **When** 翻訳処理を実行する, **Then** 日本語に翻訳されたテキストが返される
2. **Given** 翻訳言語モデルがインストール済みの場合, **When** オフライン環境で翻訳を実行する, **Then** ネットワーク接続なしで翻訳が完了する
3. **Given** 既存のパイプラインで英語サマリーが検出された場合, **When** translate_summary関数が呼ばれる, **Then** argos-translate を使用して翻訳が実行される

---

### User Story 2 - 言語モデルの自動セットアップ (Priority: P2)

ユーザーが初回セットアップ時またはパイプライン実行時に、必要な英日翻訳モデルが自動的にダウンロード・インストールされる。手動でのモデル管理は不要。

**Why this priority**: 言語モデルがなければ翻訳機能は動作しない。ただし、一度セットアップすれば再実行は不要なため、基本翻訳機能より優先度は低い。

**Independent Test**: 新規環境で初回実行し、モデルが自動インストールされることを確認。

**Acceptance Scenarios**:

1. **Given** 英日翻訳モデルがインストールされていない場合, **When** 翻訳機能を初めて使用する, **Then** 必要なモデルが自動的にダウンロード・インストールされる
2. **Given** 英日翻訳モデルが既にインストール済みの場合, **When** 翻訳機能を使用する, **Then** モデルの再ダウンロードは行われず即座に翻訳が開始される

---

### User Story 3 - エラー時のフォールバック (Priority: P3)

argos-translate での翻訳が失敗した場合、適切なエラーハンドリングを行い、翻訳なしでも処理を継続できる。

**Why this priority**: 翻訳失敗がパイプライン全体を停止させないための堅牢性。主機能が動作することが前提なため優先度は低い。

**Independent Test**: 意図的にエラー状態を作り、エラー処理が正しく動作することを確認。

**Acceptance Scenarios**:

1. **Given** 翻訳処理でエラーが発生した場合, **When** エラーがキャッチされる, **Then** エラーメッセージがログに記録され、元の英語テキストがそのまま使用される
2. **Given** 言語モデルのダウンロードが失敗した場合, **When** 再試行後も失敗する, **Then** 翻訳機能は無効化され、英語テキストのまま処理が継続される

---

### Edge Cases

- 空のテキストまたはNoneが渡された場合の処理
- 非常に長いテキスト（1万文字以上）の翻訳パフォーマンス
- 英語以外のテキスト（既に日本語、または他言語）が渡された場合の挙動
- ディスク容量不足でモデルをダウンロードできない場合
- 複数プロセスが同時にモデルをダウンロードしようとした場合の排他制御

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは argos-translate ライブラリを使用して英語から日本語への翻訳を実行できなければならない
- **FR-002**: システムは必要な言語モデル（en→ja）を自動的にダウンロード・インストールできなければならない
- **FR-003**: 翻訳処理はオフライン環境で動作しなければならない（初回モデルダウンロード後）
- **FR-004**: 既存の `translate_summary` 関数のインターフェースを維持し、呼び出し元コードの変更を最小限にしなければならない
- **FR-005**: 翻訳エラー時は元の英語テキストを保持し、通常の出力先（notes/）に出力して処理を継続しなければならない（reviewへの振り分け対象外）
- **FR-006**: システムはモデルのインストール状態を確認し、未インストールの場合のみダウンロードを実行しなければならない
- **FR-007**: 空テキストまたはNone入力時は翻訳をスキップし、入力値をそのまま返さなければならない

### Key Entities

- **TranslationModel**: 言語ペア（en→ja）の翻訳モデル。インストール状態、バージョン情報を持つ
- **TranslationResult**: 翻訳結果。翻訳後テキスト、成功/失敗フラグ、エラーメッセージを含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 翻訳処理が現行のLLM翻訳より高速に完了する（目安: 1文あたり1秒以内）
- **SC-002**: オフライン環境での翻訳成功率が95%以上
- **SC-003**: 初回モデルダウンロードが5分以内に完了する（通常のネットワーク環境）
- **SC-004**: 既存のパイプラインテストが引き続きパスする
- **SC-005**: 翻訳品質について、元のLLM翻訳と同等の可読性を維持する

## Clarifications

### Session 2026-02-16

- Q: 翻訳エラー時のファイル出力先は？ → A: reviewに移動しない（通常出力、英語のまま）
- Q: argos-translate の翻訳品質がLLMより劣る場合の対応は？ → A: 導入中止（LLM翻訳を維持）

## Rejection Reason

**決定**: 機能導入を中止

**理由**: 実機テストの結果、argos-translate の翻訳品質が LLM (gpt-oss:20b) と比較して明確に劣ることが判明。

| 問題点 | 例 |
|--------|-----|
| 主客関係の逆転 | "ユーザーに尋ねました" (正: ユーザーが尋ねた) |
| 技術用語の誤訳 | "circular reference" → "円の参照" (正: 循環参照) |
| 主語の欠落 | "求めた" (誰が？) |

**速度向上** (0.05s vs 3-5s) よりも **翻訳品質** を優先し、現行の LLM 翻訳を維持する。

## Assumptions

- ユーザーの環境にはPython 3.11以上がインストールされている
- 初回セットアップ時にはインターネット接続が利用可能
- argos-translate が依存するシステムライブラリ（CTranslate2等）はpip installで自動インストールされる
- 英日翻訳モデルのサイズは数百MB程度を想定
- GPU環境は必須ではない（CPUでも動作可能）

## Scope Boundaries

### In Scope

- `translate_summary` 関数の実装をargos-translateに置き換え
- 言語モデルの自動ダウンロード機能
- 基本的なエラーハンドリング

### Out of Scope

- 英日以外の言語ペアのサポート
- 翻訳品質のカスタマイズ（モデルのファインチューニング等）
- GUI による言語モデル管理
- 翻訳キャッシュ機能
- GPU アクセラレーションの設定
