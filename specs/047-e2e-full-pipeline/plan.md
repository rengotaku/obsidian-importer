# Implementation Plan: E2E Full Pipeline Validation

**Branch**: `047-e2e-full-pipeline` | **Date**: 2026-02-05 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/047-e2e-full-pipeline/spec.md`

## Summary

E2E テストを `format_markdown` ノードまでの部分テストから、Organize パイプライン完了後のフルパイプラインテストに拡張する。主要な変更点は：
1. `move_to_vault` ノードの Vault 書き込みを廃止
2. `genre`, `topic` を frontmatter に埋め込む（階層構造: genre → topic → tags）
3. ゴールデンファイルを Organize 後の最終出力に更新
4. `golden_comparator` の必須キーリストを拡張

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: Kedro 1.1.1, kedro-datasets, PyYAML 6.0+, tenacity 8.x, difflib (stdlib)
**Storage**: ファイルシステム (Markdown, JSON, JSONL)、Kedro DataCatalog (PartitionedDataset)
**Testing**: unittest (Python stdlib)
**Target Platform**: Linux (ローカル開発)
**Project Type**: Single project (CLI ETL pipeline)
**Performance Goals**: N/A (E2E テストはバッチ処理)
**Constraints**: Ollama 起動必須（LLM 処理）、80% 類似度閾値
**Scale/Scope**: 3 ゴールデンファイル（テストフィクスチャ）

## Constitution Check

*GATE: No constitution file found. Proceeding with standard project conventions.*

- [x] Follow existing Kedro pipeline patterns
- [x] Use unittest (not pytest)
- [x] Preserve backward compatibility with existing tests

## Project Structure

### Documentation (this feature)

```text
specs/047-e2e-full-pipeline/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/obsidian_etl/
├── pipelines/
│   ├── organize/
│   │   ├── nodes.py      # MODIFY: add extract_topic, embed_frontmatter_fields; remove move_to_vault file I/O
│   │   └── pipeline.py   # MODIFY: add extract_topic node, update pipeline flow
│   └── transform/
│       └── nodes.py      # REVIEW: understand data flow

tests/
├── e2e/
│   ├── golden_comparator.py    # MODIFY: add genre, topic to required keys
│   └── test_golden_comparator.py  # ADD: new tests for extended frontmatter
├── fixtures/
│   └── golden/                  # UPDATE: regenerate with full pipeline output
└── pipelines/organize/
    └── test_nodes.py            # UPDATE: add extract_topic tests, adjust existing tests
```

**Structure Decision**: Single project (existing Kedro pipeline structure)

## Complexity Tracking

No violations to justify. Changes are minimal and follow existing patterns.

---

# Phase 0: Research

## Research Task 1: Current Pipeline Data Flow

**Question**: How does data flow from `format_markdown` to `move_to_vault`?

**Findings**:
1. `format_markdown` (transform/nodes.py) outputs `dict[filename, markdown_content]`
2. `classify_genre` (organize/nodes.py) expects `dict[str, Callable]` from PartitionedDataset
3. Pipeline flow: `markdown_notes` → `classify_genre` → `normalize_frontmatter` → `clean_content` → `determine_vault_path` → `move_to_vault`

**Decision**: Replace `determine_vault_path` with `extract_topic`. Add `embed_frontmatter_fields` at the end.

## Research Task 2: Frontmatter Structure

**Question**: What fields are in current golden files vs. what Organize pipeline adds?

**Current golden files (format_markdown output)**:
```yaml
title: ...
created: YYYY-MM-DD
tags: []
source_provider: claude
file_id: xxx
normalized: true
```

**Target golden files (after clarification)**:
```yaml
title: ...
created: YYYY-MM-DD
tags: [...]
source_provider: claude
file_id: xxx
normalized: true
summary: ...
genre: engineer|business|economy|daily|other
topic: aws|kubernetes|...  # LLM 抽出、小文字正規化、空許容
```

**Decision**: 階層構造を採用（genre → topic → tags）。`vault_path` は廃止。

## Research Task 3: Topic Extraction Rules

**Question**: How should `topic` be extracted and normalized?

**Findings** (from clarification):
1. LLM が会話内容から主題を抽出
2. 小文字に正規化（AWS → aws）
3. スペースは保持（React Native → react native）
4. 空文字許容（抽出できない場合）

**Decision**: 新規ノード `extract_topic` を追加。LLM 呼び出し + 正規化処理。

## Research Task 4: Required Keys for golden_comparator

**Question**: What keys does `calculate_frontmatter_similarity` check?

**Findings** (from tests/e2e/golden_comparator.py):
- Key existence check against all golden keys (30% weight)
- `file_id` exact match (40% weight)
- `title` similarity (20% weight)
- `tags` similarity (10% weight)

**Decision**: No code change needed in `calculate_frontmatter_similarity` - it dynamically checks all keys from golden. But test samples need updating with `genre`, `topic`.

---

# Phase 1: Design

## Data Model

### Frontmatter 階層構造

```
genre（大分類）→ topic（中分類）→ tags（詳細タグ）
```

| Level | Field | Example | Required | Empty Allowed |
|-------|-------|---------|----------|---------------|
| 大分類 | `genre` | `engineer` | Yes | No |
| 中分類 | `topic` | `aws` | Yes | Yes |
| 詳細 | `tags` | `["rds", "lambda"]` | Yes | Yes (empty list) |

### Entity: Final Markdown Output (post-Organize)

| Field | Type | Source | Description |
|-------|------|--------|-------------|
| `title` | string | LLM extraction | Japanese title |
| `created` | date (YYYY-MM-DD) | ParsedItem.created_at | Creation date |
| `tags` | list[string] | LLM extraction | Detail tags |
| `source_provider` | string | ParsedItem | "claude", "openai", "github" |
| `file_id` | string | SHA256 hash | 12-char truncated hash |
| `normalized` | boolean | Always `true` | Normalization flag |
| `summary` | string | LLM extraction | Japanese summary |
| `genre` | string | classify_genre | "engineer", "business", "economy", "daily", "other" |
| `topic` | string | extract_topic (NEW) | LLM 抽出 + 小文字正規化、空許容 |

### State Transitions

```
format_markdown output → classify_genre → extract_topic (NEW) → normalize_frontmatter → clean_content → embed_frontmatter_fields (NEW)
```

## Contracts

### Node: extract_topic (New)

**Purpose**: LLM を使用して会話から topic を抽出し、小文字に正規化

**Input**:
```python
partitioned_input: dict[str, Callable]  # classified_items
params: dict  # organize params (ollama settings)
```

**Output**:
```python
dict[str, dict]  # items with "topic" field added
```

**Behavior**:
1. LLM で会話内容から topic を抽出
2. 小文字に正規化（AWS → aws）
3. スペースは保持（React Native → react native）
4. 抽出失敗時は空文字

### Node: embed_frontmatter_fields (New)

**Replaces**: `move_to_vault` (file writing behavior only) + `determine_vault_path`

**Input**:
```python
partitioned_input: dict[str, Callable]  # cleaned_items
params: dict  # organize params
```

**Output**:
```python
dict[str, str]  # content with genre/topic/summary in frontmatter
```

**Behavior**:
1. Parse existing frontmatter from `item["content"]`
2. Add `genre`, `topic`, `summary` fields
3. Rebuild content with updated frontmatter
4. Return dict without file I/O

### Makefile Changes

**test-e2e**:
- Remove `--to-nodes=format_markdown`
- Let pipeline run to completion

**test-e2e-update-golden**:
- Same: remove `--to-nodes=format_markdown`

## Quickstart

### Implementation Steps

1. **Add `extract_topic` node to `organize/nodes.py`**:
   - LLM 呼び出しで topic 抽出
   - 小文字正規化
   - 空文字許容

2. **Modify `embed_frontmatter_fields` node**:
   - `vault_path` → `topic` に変更
   - `genre`, `topic`, `summary` を frontmatter に埋め込む

3. **Update `organize/pipeline.py`**:
   - `extract_topic` ノード追加
   - `determine_vault_path` 削除
   - `move_to_vault` → `embed_frontmatter_fields`

4. **Update Makefile**:
   - Remove `--to-nodes=format_markdown` from E2E targets

5. **Regenerate golden files**:
   - Run `make test-e2e-update-golden`
   - Verify new frontmatter structure (`genre`, `topic`)

6. **Update tests**:
   - Add tests for `extract_topic`
   - Update `embed_frontmatter_fields` tests
   - Verify `test_golden_comparator.py` passes

7. **Verify E2E**:
   - Run `make test-e2e`
   - Confirm 100% self-comparison

---

## Open Questions

None. All requirements are clear from spec clarifications.

## Risks

1. **LLM non-determinism**: Mitigated by 80% threshold (same as 046)
2. **Topic extraction quality**: May need prompt tuning
3. **Backward compatibility**: Existing organize tests may need adjustment
