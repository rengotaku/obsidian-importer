# Feature Specification: Vault配下ファイル階層化

**Feature Branch**: `013-vault-hierarchy`
**Created**: 2026-01-15
**Status**: Draft
**Input**: User description: "vault配下を階層化したい。@indexから移動する際に階層化するか、organizeあとに別途で整理するようにしたほうが良いのか決まっていない。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 既存ファイルの階層整理 (Priority: P1)

ユーザーは各Vault（エンジニア、ビジネス、経済、日常、その他）のルートに散在する大量のファイルを、内容に基づいたサブフォルダへ整理したい。これにより、関連するファイルを見つけやすくし、Vault全体の見通しを改善する。

**Why this priority**: Vaultルートに1000以上のファイルが存在し、ナビゲーションが困難。既存資産の整理が最優先。

**Independent Test**: エンジニアVaultのファイル10件を手動で選択し、適切なサブフォルダへ分類・移動できることを確認。移動後、Obsidianから正常にアクセス可能。

**Acceptance Scenarios**:

1. **Given** エンジニアVaultのルートにDockerに関するファイルが5件ある, **When** 階層整理を実行, **Then** 「Docker」または「コンテナ」サブフォルダに5件すべてが移動される
2. **Given** ファイルに内部リンク `[[他ファイル]]` が含まれる, **When** ファイルを移動, **Then** リンク先が同一Vault内の場合、リンクは引き続き機能する
3. **Given** 分類先が曖昧なファイル, **When** 階層整理を実行, **Then** 最も関連性の高いフォルダに配置されるか、汎用フォルダ（例：「その他」や「未分類」）に配置される

---

### User Story 2 - @indexからの移動時に階層配置 (Priority: P2)

ユーザーは@indexからVaultへファイルを移動する際、ジャンル分類と同時にサブフォルダへの配置も行いたい。これにより、移動後に再度整理する手間を省く。

**Why this priority**: 新規ファイルの流入を効率化。P1の既存整理が完了した後、この機能が価値を発揮。

**Independent Test**: @indexにテストファイル3件を配置し、organize実行時にVaultの適切なサブフォルダへ直接配置されることを確認。

**Acceptance Scenarios**:

1. **Given** @indexにAWSに関する技術ファイルがある, **When** organizeコマンドを実行, **Then** エンジニア/AWS学習 または エンジニア/クラウド サブフォルダに配置される
2. **Given** 既存のサブフォルダ構造がある, **When** 新ファイルを配置, **Then** 既存フォルダを優先して再利用し、不要な重複フォルダを作成しない

---

### User Story 3 - 階層構造のプレビューと確認 (Priority: P3)

ユーザーは実際にファイルを移動する前に、提案される階層構造をプレビューし、必要に応じて調整したい。誤った分類による情報の喪失を防ぐ。

**Why this priority**: 安全性のための機能。P1/P2が動作した後、信頼性向上のために追加。

**Independent Test**: ドライランモードで10件のファイルの移動先を表示し、ユーザーが確認・修正できることを確認。

**Acceptance Scenarios**:

1. **Given** 整理対象のファイルが50件ある, **When** プレビューモードを実行, **Then** 各ファイルの現在位置と提案先が一覧表示される
2. **Given** プレビュー結果に誤分類がある, **When** ユーザーが手動で修正, **Then** 修正内容が反映されて移動が実行される

---

### Edge Cases

- 同名ファイルが移動先に既に存在する場合は？→ ファイル名にサフィックス（_1, _2等）を付与して衝突を回避
- サブフォルダ名の候補が複数ある場合は？→ 既存フォルダを優先、なければ最も具体的な名称を採用
- ファイル内容が空または極端に短い場合は？→ ファイル名のみで分類を試行、不可なら「未分類」へ
- 画像やPDFなど非Markdownファイルは？→ 同一フォルダ内の関連Markdownと同じ場所に配置、関連がなければ現在位置を維持

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、Markdownファイルの内容（タイトル、タグ、本文）を解析し、適切なサブフォルダを提案できなければならない
- **FR-002**: システムは、既存のサブフォルダ構造を認識し、新規フォルダ作成より既存フォルダへの配置を優先しなければならない
- **FR-003**: システムは、ファイル移動前にプレビュー（ドライラン）モードを提供しなければならない
- **FR-004**: システムは、ファイル名の衝突時に自動的にリネームして安全に移動しなければならない
- **FR-005**: システムは、移動したファイルの内部リンクが壊れないようObsidianリンク形式を維持しなければならない
- **FR-006**: システムは、@indexからの移動時にジャンル分類と階層配置を1回のLLM呼び出しで同時に実行しなければならない（統合型）
- **FR-007**: システムは、各Vault固有のサブフォルダ構造テンプレートを持ち、一貫した階層を維持しなければならない

### Key Entities

- **Vault**: エンジニア、ビジネス、経済、日常、その他の5つの主要分類領域。各Vaultは独自のサブフォルダ構造を持つ
- **サブフォルダ**: Vault内のトピック別ディレクトリ。例：エンジニア/Docker、エンジニア/AWS学習
- **ファイルメタデータ**: frontmatterのtitle、tags、createdなど。分類判定に使用
- **移動ログ**: ファイルの移動履歴を記録。ロールバックや監査に使用

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Vaultルート直下のファイル数が現在の90%以上から10%未満に減少する
- **SC-002**: 目的のファイルを見つけるまでのナビゲーションステップが平均3ステップ以内になる
- **SC-003**: 階層整理処理が1000ファイルあたり10分以内に完了する
- **SC-004**: 誤分類率（ユーザーが後から手動で移動する必要があるファイル）が5%未満である
- **SC-005**: 内部リンクの破損率が0%である（すべてのリンクが移動後も正常に機能する）

## Assumptions

- Ollamaまたは同等のLLMがローカルで利用可能で、ファイル内容の解析に使用できる
- 既存のサブフォルダ構造（エンジニア/Docker、エンジニア/AWS学習など）は妥当な分類として維持する
- ユーザーは日本語ファイル名・フォルダ名を使用する
- 一度に処理するファイル数は最大1000件程度を想定
