# Feature Specification: 出力コンテンツの圧縮率改善

**Feature Branch**: `050-fix-content-compression`
**Created**: 2026-02-09
**Status**: Draft
**Input**: Issue #12 - Transform: 出力コンテンツの過度な圧縮（情報欠落）

## 問題の背景

Transform ステージで LLM が会話から知識を抽出する際、出力される Markdown の本文コンテンツが元の会話に対して過度に圧縮され、重要な情報が欠落している。

### 現状の計測結果

| 指標 | 値 |
|------|-----|
| 総ファイル数 | 287 |
| 平均圧縮率（全体） | 44.4% |
| 平均圧縮率（本文のみ） | 30.5% |
| Body% < 5% のファイル数 | 約30件（重大な情報欠落） |

### 問題ファイル例

| ファイル | 元サイズ | 本文サイズ | Body% |
|---------|---------|-----------|-------|
| Git操作 | 23,755文字 | 34文字 | 0.1% |
| Python (pyenv) | 21,998文字 | 195文字 | 0.9% |
| 設定を反映 | 20,209文字 | 270文字 | 1.3% |

### 根本原因

現在の `knowledge_extraction.txt` プロンプトには：
- 「構造化されたまとめ」という曖昧な指示のみ
- 情報量の保持に関する具体的な指示がない
- 最小本文サイズの目安がない
- コード・手順の省略禁止ルールがない

## User Scenarios & Testing

### User Story 1 - 適切な情報量の保持 (Priority: P1)

ユーザーが変換後の Markdown ファイルを読んだとき、元の会話に含まれる重要な情報（コード例、手順、詳細説明）が実用的なレベルで保持されている。

**Why this priority**: 情報が欠落したノートは価値がなく、ナレッジベースとして機能しない。この問題を解決しないと他の改善も意味がない。

**Independent Test**: 変換後のファイルを読んで、元の会話を参照せずに内容を理解・実行できるかを確認。

**Acceptance Scenarios**:

1. **Given** コード例を含む会話（例: Git操作）, **When** Transform を実行, **Then** 出力に主要なコードブロックがすべて含まれる
2. **Given** 手順を含む会話（例: インストール手順）, **When** Transform を実行, **Then** 出力にすべてのステップが含まれる
3. **Given** 比較情報を含む会話（例: ツール比較）, **When** Transform を実行, **Then** 出力に比較表または比較情報が含まれる

---

### User Story 2 - 圧縮率の品質基準達成 (Priority: P1)

変換後のファイルの本文サイズが、元の会話に対して適切な圧縮率（目標: Body% 10%以上）を維持する。

**Why this priority**: 定量的な品質基準がないと、改善の効果を測定できない。

**Independent Test**: 圧縮率計算スクリプトを実行し、Body% < 10% のファイル数が大幅に減少していることを確認。

**Acceptance Scenarios**:

1. **Given** 元サイズ 10,000文字以上の会話, **When** Transform を実行, **Then** 本文サイズが元の 10% 以上（1,000文字以上）
2. **Given** 元サイズ 5,000-10,000文字の会話, **When** Transform を実行, **Then** 本文サイズが元の 15% 以上
3. **Given** 元サイズ 5,000文字未満の会話, **When** Transform を実行, **Then** 本文サイズが元の 20% 以上

---

### User Story 3 - コード保持の保証 (Priority: P2)

会話内の重要なコードブロックが、変換後のファイルに完全な形で含まれる。

**Why this priority**: エンジニアリング系のナレッジではコードが最も重要な情報。省略されると価値が大幅に低下。

**Independent Test**: コードを含む会話を変換し、コードブロックの数と完全性を検証。

**Acceptance Scenarios**:

1. **Given** 3つのコードブロックを含む会話, **When** Transform を実行, **Then** 出力に少なくとも2つ以上のコードブロックが含まれる
2. **Given** 10行以上のコードを含む会話, **When** Transform を実行, **Then** コードが省略されず完全な形で出力される
3. **Given** 設定ファイル（YAML, JSON等）を含む会話, **When** Transform を実行, **Then** 設定内容が完全な形で出力される

---

### Edge Cases

- 元の会話が極端に短い場合（1,000文字未満）: 最低限の構造化は行うが、圧縮率基準は緩和
- 会話の大半がコードの場合: コードを優先的に保持し、説明は簡潔に
- 雑談が多く実質的な情報が少ない会話: 圧縮率が低くなるのは許容
- チャンク分割された会話: 各チャンクで独立した圧縮率を維持

## Requirements

### Functional Requirements

- **FR-001**: システムは、LLM への知識抽出プロンプトに最小情報量の目安を含めなければならない
- **FR-002**: システムは、コードブロックを省略せず完全な形で出力するようプロンプトで指示しなければならない
- **FR-003**: システムは、手順・ステップ情報を省略せず出力するようプロンプトで指示しなければならない
- **FR-004**: システムは、元の会話サイズに応じた最小本文サイズの目安をプロンプトに含めなければならない
- **FR-005**: システムは、変換後の圧縮率が基準を下回った場合に警告ログを出力しなければならない（すべての transform node で共通処理として実装。本文が存在する場合のみ検証）
- **FR-006**: システムは、圧縮率が段階的基準（10K+→10%, 5-10K→15%, <5K→20%）を下回るファイルを `data/07_model_output/review/` に出力しなければならない
- **FR-007**: システムは、レビュー対象ファイルの frontmatter に `review_reason` フィールド（node名 + 圧縮率）を追加しなければならない

### Key Entities

- **会話データ (ParsedItem)**: 元の会話内容、文字数、メッセージ数を持つ
- **抽出結果 (ExtractedKnowledge)**: タイトル、要約、タグ、本文を持つ
- **圧縮率メトリクス**: 元サイズ、出力サイズ、本文サイズ、圧縮率を持つ

## Success Criteria

### Measurable Outcomes

- **SC-001**: Body% < 5% のファイル数が、現状の約30件から5件以下に減少する
- **SC-002**: 平均本文圧縮率（Body%）が、現状の30.5%から50%以上に改善する
- **SC-003**: コードを含む会話の変換後ファイルで、主要なコードブロックが90%以上保持される
- **SC-004**: 手順を含む会話の変換後ファイルで、全ステップが保持される

## Assumptions

- LLM（Ollama）はプロンプトの指示に従って出力量を調整できる
- 圧縮率の計算は、frontmatter を除いた本文部分のみで行う
- チャンク分割された会話は、各チャンク単位で圧縮率を評価する
- 「重要なコード」の判断は LLM に委ねるが、省略は禁止する

## Clarifications

### Session 2026-02-09

- Q: 圧縮率警告ログは全ての node で検証するか、特定の node か？ → A: すべての transform node で共通処理として検証。新規 node にも自動適用。本文が存在する場合のみ有効。
- Q: 圧縮率警告のしきい値は？ → A: User Story 2 の段階的基準に従う（10K+→10%, 5-10K→15%, <5K→20%）
- Q: 圧縮率基準未達時のアクションは？ → A: 基準未達ファイルを別フォルダに出力（レビュー用）
- Q: レビューファイルで発生 node を確認できるか？ → A: frontmatter に `review_reason` フィールド追加（node名 + 圧縮率を記録）
- Q: 復帰処理の想定は？ → A: 手動確認後、ユーザーが `organized/` へ移動（自動復帰はスコープ外）

## Scope

### In Scope

- `knowledge_extraction.txt` プロンプトの改善
- 圧縮率警告ログの追加
- E2E テストでの圧縮率検証

### Out of Scope

- LLM モデルの変更
- チャンク分割ロジックの変更
- 既存ファイルの再変換（手動対応）
- レビューフォルダからの自動復帰処理（手動で `organized/` へ移動）
