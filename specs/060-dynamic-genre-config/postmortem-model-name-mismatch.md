# ポストモーテム: Ollama モデル名不整合と動作検証の問題

**日時**: 2026-02-22
**重要度**: 高
**カテゴリ**: 設定・環境・検証プロセス

## 問題サマリー

1. **モデル名不整合**: 設定の `oss-gpt:20b` と実際の `gpt-oss:20b` が異なる
2. **不適切な対処**: 別モデルでテストを試みて本質的な問題を見逃した
3. **タイムアウト問題**: モデルロード時間を考慮していない設定
4. **ホットロード未考慮**: 初回呼び出し時のモデルロード時間を考慮していない

## 発生経緯

### Phase 1: モデル名の認識ミス

```
設定ファイル: model: "oss-gpt:20b"
Ollama 実際:  model: "gpt-oss:20b"
```

API 呼び出し → "Not Found" エラー

### Phase 2: 不適切な対処

エージェントの誤った判断:
> "oss-gpt:20b モデルが存在しません（gpt-oss:20b が正しい名前）。gemma3:12b でテストします。"

**問題点**:
- 本来は設定ファイルの修正が必要
- 別モデルでの代替は根本解決にならない
- ユーザーの環境設定を無視した判断

### Phase 3: タイムアウト問題

- `gpt-oss:20b` のロード時間: ~55秒
- 設定のタイムアウト: 30秒
- 結果: 初回呼び出しは必ずタイムアウト

### Phase 4: ホットロードの欠如

- モデルは使用前にロードされている必要がある
- パイプライン起動時にモデルをプリロードしていない
- テスト時にこの前提条件を確認していない

## 根本原因

| 問題 | 原因 | 影響 |
|------|------|------|
| モデル名不整合 | 設定ファイルのタイプミス | API呼び出し失敗 |
| 不適切対処 | 問題の本質を理解せず代替案に逃げた | 時間浪費、問題の隠蔽 |
| タイムアウト | モデルロード時間を考慮していない | 初回呼び出し失敗 |
| ホットロード | 起動時プリロードがない | テスト再現性の欠如 |

## 本来あるべき対処

1. **モデル名確認**: `ollama list` で利用可能モデルを確認
2. **設定修正**: 設定ファイルを正しいモデル名に修正
3. **プリロード**: テスト/起動前にモデルをロード
4. **タイムアウト調整**: モデルロード時間を考慮した値に設定

## 対策

### 即時対応

```bash
# 1. モデル名を確認
ollama list | grep -i gpt

# 2. 設定を修正（今回はユーザー判断で未適用）
# sed -i 's/oss-gpt:20b/gpt-oss:20b/g' conf/base/parameters.yml

# 3. モデルをプリロード
curl -s http://localhost:11434/api/generate -d '{"model": "gpt-oss:20b", "prompt": "hello"}' > /dev/null
```

### 恒久対策

1. **起動時バリデーション**
   - パイプライン起動時に設定モデルの存在確認
   - 不在時は利用可能モデル一覧を表示してエラー

2. **プリロード機構**
   - `make warmup` ターゲット追加
   - パイプライン起動時に自動プリロード

3. **テスト環境整備**
   - CI/テスト用のモック設定
   - 実環境テスト時のプリロード手順を文書化

4. **エラーメッセージ改善**
   - "Not Found" 時に `ollama list` の結果を表示
   - 類似モデル名のサジェスト

## 学び

1. **エラーの根本原因を追求する**: 代替案に逃げない
2. **ユーザー環境を尊重する**: 勝手にモデルを変更しない
3. **前提条件を確認する**: ホットロード状態など環境依存を考慮
4. **設定変更は慎重に**: 変更前に影響範囲を確認

## 未解決事項

- [ ] `conf/base/parameters.yml` のモデル名修正（ユーザー判断待ち）
- [ ] タイムアウト値の最適化
- [ ] プリロード機構の実装
- [ ] 起動時バリデーションの実装

## 関連リソース

- Ollama API: http://localhost:11434
- 設定ファイル: `conf/base/parameters.yml`
- モデル一覧: `ollama list`
