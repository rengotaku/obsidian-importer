# Phase 4 Output

## 作業概要
- User Story 3: プレースホルダータイトルの防止 の実装完了
- プロンプトに禁止事項セクションを追加し、LLM がプレースホルダーをタイトルとして採用しないようにした
- プロンプト改善のみのため TDD は不要（テスト追加なし）

## 修正ファイル一覧
- `src/obsidian_etl/utils/prompts/knowledge_extraction.txt`
  - 新規セクション「## 禁止事項」を追加（品質基準セクションの直前）
  - プレースホルダーの具体例を明記
  - タイトルの具体性に関する指示を強化

## 実装詳細

### 追加セクション: 禁止事項（line 87-94）

```markdown
## 禁止事項

タイトルに以下を含めないでください:
- プレースホルダー: `(省略)`, `（省略）`, `[トピック名]`, `[タイトル]`, `[具体的な内容]`
- 省略記号のみ: `...`, `<...>`, `…`
- 例文からの引用: プロンプト内の例文をタイトルとして使用しない

タイトルは会話の実際の内容を反映する具体的なものにしてください。
```

**配置理由**:
- 品質基準セクションの直前に配置（コード例の直後）
- LLM が出力生成前に明確な禁止事項を認識できる

**禁止対象の具体例**:
1. **プレースホルダー**: `(省略)`, `（省略）`, `[トピック名]`, `[タイトル]`, `[具体的な内容]`
   - プロンプト内の構造説明で使用される形式的な文字列
2. **省略記号**: `...`, `<...>`, `…`
   - 内容の省略を示す記号のみのタイトル
3. **例文からの引用**: プロンプト内の例として提示されたテキストをそのまま使用

## テスト結果

### 全体テスト結果
```
Ran 293 tests in 0.799s

OK
```

全テスト PASS、リグレッションなし（プロンプト変更のみのため既存テストに影響なし）。

## Functional Requirements 達成状況

| FR | 要件 | ステータス |
|----|------|-----------|
| FR-007 | システムはプレースホルダータイトルを防止しなければならない | ✅ Complete |

## User Story ステータス

### US1: 空コンテンツファイルの除外（Phase 2 完了）
✅ Complete - LLM が空の summary_content を返した場合、アイテムを除外

### US2: タイトルサニタイズ（Phase 3 完了）
✅ Complete - タイトルから絵文字、ブラケット、ファイルパス記号を除去

### US3: プレースホルダータイトルの防止（Phase 4 完了）
✅ Complete - プロンプトにプレースホルダー禁止ルールを追加

## 次 Phase への引き継ぎ

### Phase 5: User Story 4 - トピック粒度の適正化
**タスク**:
- プロンプト改善のみ（TDD 対象外）
- `src/obsidian_etl/pipelines/organize/nodes.py` の `_extract_topic_via_llm` プロンプトを更新
- 抽象度レベルの指示を追加（例: `バナナプリン` → `離乳食`）

**前提**:
- US1, US2, US3 の機能が正常動作している
- テストに影響なし（プロンプト変更のみ）

## 注意点

### プロンプトベースの品質向上
プレースホルダー禁止は LLM への指示で実現しているため:
- **検証方法**: E2E テストまたは実際の会話処理で確認が必要
- **完全保証**: LLM の動作に依存するため 100% の保証はない
- **効果測定**: Phase 7 の E2E テストで実際の出力を検証

### 既存プロンプトとの一貫性
- 禁止事項セクションを品質基準の直前に配置
- 既存の抽出ルールや出力形式との整合性を維持
- NG 例セクションとの補完関係

### LLM への明示的指示の重要性
- 具体例を明記することで LLM の理解を助ける
- 日本語の全角/半角両方のパターンを列挙
- 「具体的なものにしてください」という肯定的な指示も追加

## 実装のミス・課題

特になし。プロンプト改善のみで既存テストに影響なし。
