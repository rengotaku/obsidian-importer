# Phase 5 Output

## 作業概要
- User Story 4: トピック粒度の適正化 の実装完了
- `_extract_topic_via_llm` プロンプトにカテゴリレベル（上位概念）抽出の指示を追加
- 具体例を明記（バナナプリン → 離乳食、iPhone → スマートフォン、Claude → AI）
- プロンプト改善のみのため TDD は不要（テスト追加なし）

## 修正ファイル一覧
- `src/obsidian_etl/pipelines/organize/nodes.py`
  - `_extract_topic_via_llm` 関数のプロンプト更新（line 238-244）
  - カテゴリレベル抽出の指示を追加
  - 具体例 3 件を明記

## 実装詳細

### 更新プロンプト（_extract_topic_via_llm）

**Before**:
```python
prompt = f"""この会話から主題（トピック）を1つ抽出してください。

会話内容:
{body[:1000]}

主題を1単語または2単語程度で答えてください（例: AWS, Kubernetes, React Native, Python）。
抽出できない場合は空文字を返してください。"""
```

**After**:
```python
prompt = f"""この会話から主題（トピック）を1つ抽出してください。

会話内容:
{body[:1000]}

主題をカテゴリレベル（1-3単語）で答えてください。
具体的な商品名・料理名・固有名詞ではなく、上位概念で答えてください。

例:
- バナナプリンの作り方 → 離乳食
- iPhone 15 Pro の設定 → スマートフォン
- Claude 3.5 Sonnet の使い方 → AI

抽出できない場合は空文字を返してください。"""
```

**変更点**:
1. **カテゴリレベル指示**: "カテゴリレベル（1-3単語）で答えてください"
2. **抽象化要求**: "具体的な商品名・料理名・固有名詞ではなく、上位概念で答えてください"
3. **具体例の追加**: 3 件の具体例で期待される抽象度を明示
   - `バナナプリンの作り方` → `離乳食` (料理名 → カテゴリ)
   - `iPhone 15 Pro の設定` → `スマートフォン` (商品名 → カテゴリ)
   - `Claude 3.5 Sonnet の使い方` → `AI` (固有名詞 → カテゴリ)

**設計意図**:
- LLM が具体的な商品名・料理名を避け、上位概念で抽出するよう誘導
- 例を通じて期待される抽象度レベルを明示
- 1-3 単語という長さ制約を維持（既存仕様との一貫性）

## テスト結果

### 全体テスト結果
```
Ran 293 tests in 0.799s

OK
```

全テスト PASS、リグレッションなし（プロンプト変更のみのため既存テストに影響なし）。

## Functional Requirements 達成状況

| FR | 要件 | ステータス |
|----|------|-----------|
| FR-008 | システムはトピックを適切な抽象度で抽出しなければならない | ✅ Complete |

## User Story ステータス

### US1: 空コンテンツファイルの除外（Phase 2 完了）
✅ Complete - LLM が空の summary_content を返した場合、アイテムを除外

### US2: タイトルサニタイズ（Phase 3 完了）
✅ Complete - タイトルから絵文字、ブラケット、ファイルパス記号を除去

### US3: プレースホルダータイトルの防止（Phase 4 完了）
✅ Complete - プロンプトにプレースホルダー禁止ルールを追加

### US4: トピック粒度の適正化（Phase 5 完了）
✅ Complete - トピック抽出プロンプトにカテゴリレベル指示を追加

## 次 Phase への引き継ぎ

### Phase 6: User Story 5 - summary/content 逆転の検出
**タスク**:
- TDD フロー（tdd-generator → phase-executor）
- `src/obsidian_etl/pipelines/transform/nodes.py` の `extract_knowledge` 関数に警告ロジックを追加
- summary が 500 文字を超える場合に警告ログを出力

**前提**:
- US1, US2, US3, US4 の機能が正常動作している
- Phase 2 で追加した `extract_knowledge` 関数の空コンテンツチェックロジックが存在

## 注意点

### プロンプトベースの品質向上
トピック抽象化は LLM への指示で実現しているため:
- **検証方法**: E2E テストまたは実際の会話処理で確認が必要
- **完全保証**: LLM の動作に依存するため 100% の保証はない
- **効果測定**: Phase 7 の E2E テストで実際の出力を検証

### 抽象度のバランス
- **過度に抽象化しない**: `React` → `プログラミング` のような過度な抽象化を避けるため、1-3 単語という長さ制約を維持
- **具体例の重要性**: LLM は例から学習するため、3 件の具体例が抽象度レベルを決定する重要な要素
- **ジャンル分類との関係**: トピックはジャンル（engineer, business, economy, daily）より細かい粒度

### 既存機能との一貫性
- トピック正規化（lowercase 変換）は維持
- 空文字フォールバックは維持
- エラーハンドリングは変更なし

## 実装のミス・課題

特になし。プロンプト改善のみで既存テストに影響なし。

## 補足情報

### トピック抽出の全体フロー
1. **organize パイプライン**: `extract_topic` ノード
2. **LLM 呼び出し**: `_extract_topic_via_llm` ヘルパー関数
3. **正規化**: 抽出結果を lowercase に変換
4. **フロントマターへの埋め込み**: `embed_frontmatter_fields` ノード

### 期待される効果
- **ディレクトリ構造の改善**: 同じカテゴリの会話が同一トピックフォルダに集約される
- **検索性の向上**: 上位概念でトピック検索が可能になる
- **重複削減**: 具体的な商品名の違いによる不要なトピック分散を防ぐ
