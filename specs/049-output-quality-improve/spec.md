# Feature Specification: 出力ファイル品質改善

**Feature Branch**: `049-output-quality-improve`
**Created**: 2026-02-08
**Status**: Draft
**Input**: GitHub Issue #4 - 出力品質問題の分析・調査

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 空コンテンツファイルの除外 (Priority: P1)

ナレッジベース管理者として、LLM抽出に失敗した空コンテンツのファイルが出力されないようにしたい。なぜなら、本文のない Markdown ファイルは Vault の品質を低下させ、検索ノイズになるからだ。

**Why this priority**: 空コンテンツファイルは最も明確な品質問題であり、フィルタリングすることで即座に Vault の品質が向上する。

**Independent Test**: `kedro run` 実行後、`data/07_model_output/organized/` に本文が空のファイルが存在しないことを確認できる。

**Acceptance Scenarios**:

1. **Given** LLM が summary_content を空で返した場合, **When** パイプラインが実行される, **Then** そのアイテムは出力から除外され、ログに警告が記録される
2. **Given** summary と tags のみで summary_content が空のアイテム, **When** 変換処理が行われる, **Then** そのアイテムはスキップされる
3. **Given** 空コンテンツでスキップされたアイテム, **When** 処理完了時, **Then** スキップ件数がサマリーに表示される

---

### User Story 2 - タイトルサニタイズ (Priority: P1)

ナレッジベース管理者として、タイトルに絵文字やシンボル、ファイルパス記号が含まれないようにしたい。なぜなら、これらの文字はファイルシステムやリンク作成で問題を起こす可能性があるからだ。

**Why this priority**: タイトル品質はファイル名に直結し、Vault 全体の整合性に影響する重要な問題である。

**Independent Test**: `kedro run` 実行後、出力ファイル名に絵文字、`[]`, `()`, `~`, `%` などの問題文字が含まれないことを確認できる。

**Acceptance Scenarios**:

1. **Given** LLM がタイトルに絵文字（例: `❌`, `🍶`）を含めた場合, **When** メタデータ生成が行われる, **Then** 絵文字が除去されたタイトルになる
2. **Given** LLM がタイトルにブラケット（例: `[トピック名]`）を含めた場合, **When** メタデータ生成が行われる, **Then** ブラケットが除去される
3. **Given** LLM がタイトルにファイルパス記号（例: `~/.bashrc`）を含めた場合, **When** メタデータ生成が行われる, **Then** 問題文字が除去される
4. **Given** サニタイズ後にタイトルが空になる場合, **When** メタデータ生成が行われる, **Then** file_id から代替タイトルが生成される

---

### User Story 3 - プレースホルダータイトルの防止 (Priority: P2)

ナレッジベース管理者として、LLM がプロンプト例文のプレースホルダー（例: `(省略)`, `[トピック名]`）をタイトルとして採用しないようにしたい。なぜなら、これらは意味のないタイトルであり、コンテンツを識別できないからだ。

**Why this priority**: 根本原因はプロンプト品質にあり、P1 のサニタイズで一部は対処できるが、本質的な解決には LLM への指示改善が必要。

**Independent Test**: 既知の問題会話を再処理し、プレースホルダータイトルが生成されないことを確認できる。

**Acceptance Scenarios**:

1. **Given** 会話中に `(省略)` という文字列がある場合, **When** 知識抽出が行われる, **Then** `(省略)` はタイトルとして採用されない
2. **Given** 会話中に例文プレースホルダーがある場合, **When** 知識抽出が行われる, **Then** 会話の本質を表すタイトルが生成される

---

### User Story 4 - トピック粒度の適正化 (Priority: P2)

ナレッジベース管理者として、トピック抽出が適切な抽象度で行われるようにしたい。なぜなら、細かすぎるトピック（例: `バナナプリン`）では分類として役に立たず、より上位のカテゴリ（例: `離乳食`）が適切だからだ。

**Why this priority**: トピック分類の品質は Vault の整理に影響するが、現在もファイルは出力されており、機能的には動作している。

**Independent Test**: 離乳食関連の会話を処理し、トピックが `離乳食` レベルの抽象度で分類されることを確認できる。

**Implementation Approach**: 抽象度指示型 - プロンプトに「具体的な商品名・料理名ではなく、カテゴリレベル（例: 離乳食, プログラミング, 旅行）で答えよ」と明示する。タグ参照は行わず、プロンプト改善のみで対応。

**Acceptance Scenarios**:

1. **Given** タグに親カテゴリ（`離乳食`）が含まれる会話, **When** トピック抽出が行われる, **Then** トピックはタグの親カテゴリ程度の抽象度になる
2. **Given** 具体的な話題（バナナプリンの作り方）, **When** トピック抽出が行われる, **Then** トピックは `離乳食` や `ベビーフード` のような上位概念になる

---

### User Story 5 - summary/content 逆転の検出 (Priority: P3)

ナレッジベース管理者として、summary が異常に長い（本来の content と逆転している）ケースを検出したい。なぜなら、巨大な summary は frontmatter を肥大化させ、ファイル構造が不適切になるからだ。

**Why this priority**: 発生頻度が低く、他の問題より影響範囲が限定的。

**Independent Test**: summary が 500 文字を超えるアイテムに対して警告ログが出力されることを確認できる。

**Acceptance Scenarios**:

1. **Given** LLM が 500 文字超の summary を返した場合, **When** 知識抽出後の検証が行われる, **Then** 警告ログが出力される
2. **Given** summary が content より長い場合, **When** 検証が行われる, **Then** summary/content 逆転の可能性としてログに記録される

---

### Edge Cases

- LLM がタイムアウトした場合はどうするか？ → 既存のリトライロジックに従い、最終的に失敗したらスキップ
- タイトルサニタイズ後に空になった場合は？ → file_id の先頭 12 文字をフォールバックタイトルとして使用
- 全アイテムがフィルタリングされた場合は？ → 警告ログを出力し、空の出力で正常終了

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは summary_content が空のアイテムを出力から除外しなければならない
- **FR-002**: システムはスキップされたアイテムの件数をログに記録しなければならない
- **FR-003**: システムはタイトルから絵文字を除去しなければならない
- **FR-004**: システムはタイトルからブラケット記号（`[]`, `()`）を除去しなければならない
- **FR-005**: システムはタイトルからファイルパス記号（`~`, `%`, `/`, `\`）を除去しなければならない
- **FR-006**: システムはサニタイズ後に空になったタイトルに対して file_id ベースの代替タイトルを生成しなければならない
- **FR-007**: LLM プロンプトはプレースホルダーをタイトルとして採用しないよう明示的に指示しなければならない
- **FR-008**: トピック抽出プロンプトは「具体的な商品名・料理名ではなく、カテゴリレベルで答えよ」という抽象度指示を含まなければならない
- **FR-009**: システムは 500 文字を超える summary に対して警告ログを出力しなければならない
- **FR-010**: 既存のパイプライン動作との後方互換性を維持しなければならない

### Key Entities

- **ProcessedItem**: 変換されたアイテム。title, summary, summary_content, tags, file_id を持つ
- **ValidationResult**: 検証結果。passed (boolean), skip_reason (string), warnings (list) を持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 出力ファイルの 100% が空でない本文を持つ
- **SC-002**: 出力ファイル名の 100% が絵文字・問題シンボルを含まない
- **SC-003**: プレースホルダータイトル（`(省略)`, `[トピック名]` 等）の発生率が 0% になる
- **SC-004**: トピック分類の抽象度が適切なファイルが 90% 以上になる
- **SC-005**: summary が 500 文字を超えるケースは 5% 未満になる
- **SC-006**: 既存のユニットテストが 100% 通過する（後方互換性）
- **SC-007**: パイプライン処理時間が現行比 110% 以内に収まる（性能劣化なし）

## Clarifications

### Session 2026-02-08

- Q: 問題は改良途中で発生したものか、現在のコードでも発生しうるか？ → A: 現在のコードでも発生する（バリデーション/サニタイズ機能が未実装）
- Q: User Story 4（トピック粒度）の対策方針は？ → A: 抽象度指示型（プロンプトに「カテゴリレベルで答えよ」と明示）

## Background Investigation

### 調査結果（2026-02-08）

問題ファイルの生成時期と現在のコードを調査した結果:

| 問題 | 現在のコードで発生するか | 根拠 |
|------|------------------------|------|
| 空コンテンツ | 発生する | `extract_knowledge` は `error or not knowledge` のみチェック。`summary_content` が空でも通過 |
| 絵文字タイトル | 発生する | `_sanitize_filename` は `/\:*?"<>\|` のみ除去。絵文字は除去対象外 |
| ブラケットタイトル | 発生する | `[]()` は除去対象外 |
| チルダ/パーセント | 発生する | `~%` は除去対象外 |
| プレースホルダー | 発生する | プロンプトに除外ルールがない |
| summary/content逆転 | 発生する | 長さチェックがない |

**結論**: これらは「改良途中の一時的なもの」ではなく、**現在のコードに機能が不足している**ことが原因。同じ入力で再実行しても同じ問題が発生する。

### 修正対象箇所

| 問題 | 修正対象ファイル | 修正内容 |
|------|-----------------|----------|
| 空コンテンツ | `transform/nodes.py:113-116` | `summary_content` 空チェック追加 |
| 絵文字/シンボル | `transform/nodes.py:324` | サニタイズ対象文字拡張 |
| プレースホルダー | `prompts/knowledge_extraction.txt` | 除外ルール追加 |
| トピック粒度 | `organize/nodes.py:238-244` | プロンプトに抽象度指示追加（「カテゴリレベルで答えよ」） |
| summary長さ | `transform/nodes.py` | 長さ警告追加 |

## Assumptions

- Ollama LLM は引き続きローカルで利用可能
- 既存の問題ファイルは再処理で改善されることを期待（バッチ再処理は本 feature のスコープ外）
- トピック粒度の「適切さ」はカテゴリレベル（離乳食, プログラミング, 旅行 等）で判定。タグ参照は行わない
- 絵文字の定義は Unicode の Emoji カテゴリに準拠
- 問題は現在のコードの機能不足が原因であり、全て本 feature で対応する必要がある
