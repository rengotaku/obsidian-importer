# Implementation Plan: ETL Import パリティ実装

**Branch**: `026-etl-import-parity` | **Date**: 2026-01-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/026-etl-import-parity/spec.md`

## Summary

src/etl の Import Phase を src/converter/scripts/llm_import と機能的に同等にする。src/converter/scripts/llm_import/common/ から必要なモジュールを src/etl/utils/ にコピーし、現在スタブ状態の ExtractKnowledgeStep 等に統合。Ollama 知識抽出、file_id 生成、チャンク分割、英語 Summary 翻訳、@index 出力、エラー詳細ファイル出力を実装する。converter は最終的に削除予定のため、依存を完全に排除する。

## Technical Context

**Language/Version**: Python 3.13（src/etl 既存環境）
**Primary Dependencies**: tenacity 8.x（既存）、ollama API（src/etl/utils/ にコピー）
**Storage**: ファイルシステム（JSON, Markdown）、セッションフォルダ構造
**Testing**: unittest（プロジェクト標準）
**Target Platform**: Linux（ローカル開発環境）
**Project Type**: single（既存 src/etl 構造を拡張）
**Constraints**: Ollama ローカル稼働前提、コンテキスト長制限（チャンク分割で対応）
**Scale/Scope**: 1セッションあたり最大数百ファイル処理

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Vault Independence | ✅ PASS | import Phase は Vault への直接書き込みなし（@index 経由） |
| II. Obsidian Markdown Compliance | ✅ PASS | 出力は YAML frontmatter + Wiki-style リンク形式 |
| III. Normalization First | ✅ PASS | normalized: true 付与、file_id 生成 |
| IV. Genre-Based Organization | N/A | import Phase は分類を行わない（organize Phase の責務） |
| V. Automation with Oversight | ✅ PASS | --dry-run オプションで事前確認可能 |

## Project Structure

### Documentation (this feature)

```text
specs/026-etl-import-parity/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
src/etl/
├── core/                         # 既存フレームワーク（変更なし or 最小限）
│   ├── models.py                 # ProcessingItem, StepResult
│   ├── stage.py                  # BaseStage, BaseStep（JSONL 自動ログ追加）
│   ├── step.py                   # StepTracker
│   ├── retry.py                  # tenacity 統合
│   └── config.py                 # DEBUG モード設定
├── utils/                        # [新規] ユーティリティモジュール
│   ├── __init__.py
│   ├── ollama.py                 # [コピー] Ollama API クライアント
│   ├── knowledge_extractor.py    # [コピー] KnowledgeExtractor, KnowledgeDocument
│   ├── chunker.py                # [コピー] Chunker, Chunk, ChunkedConversation
│   ├── file_id.py                # [コピー] generate_file_id()
│   └── error_writer.py           # [コピー] エラー詳細ファイル出力
├── prompts/                      # [コピー] LLM プロンプトテンプレート
│   ├── knowledge_extraction.txt
│   └── summary_translation.txt
├── stages/
│   ├── extract/
│   │   └── claude_extractor.py   # ClaudeExtractor, ParseJsonStep, ValidateStructureStep
│   ├── transform/
│   │   └── knowledge_transformer.py  # [修正] ExtractKnowledgeStep, GenerateMetadataStep
│   └── load/
│       └── session_loader.py     # [修正] WriteToSessionStep, UpdateIndexStep
├── phases/
│   └── import_phase.py           # ImportPhase（既存）
└── tests/
    ├── test_import_phase.py      # 統合テスト拡張
    └── test_utils.py             # [新規] utils モジュールテスト
```

**Structure Decision**: src/converter/scripts/llm_import/common/ から必要なモジュールを src/etl/utils/ にコピー。converter は最終的に削除予定のため、依存を完全に排除する。

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

N/A - 違反なし

---

## Phase 0: Research (TODO)

See [research.md](./research.md)

## Phase 1: Design (TODO)

See [data-model.md](./data-model.md)

## Phase 2: Tasks (TODO)

See [tasks.md](./tasks.md) - Generated by `/speckit.tasks`
