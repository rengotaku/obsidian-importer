# Feature Specification: ローカルLLM品質向上

**Feature Branch**: `003-llm-quality-enhancement`
**Created**: 2026-01-11
**Status**: Draft
**Input**: User description: "タイトル、メタタグ、フォーマットを精査したい。処理をローカルのLLMにまかせているが、Claude-opusが整理したときと遜色ない形にしたい"

## Clarifications

### Session 2026-01-11

- Q: 品質目標の現実的なレベル設定は？ → A: プロンプト改善 + 後処理で70%同等を目指す
- Q: タグ一貫性の確保方法は？ → A: 既存ファイルからタグを自動抽出し、プロンプトへ注入
- Q: Markdownフォーマット正規化のアプローチは？ → A: LLMで内容精査・日本語書き直し後、ルールベースでフォーマット整形（原文が完全な英語文書なら内容は保持）
- Q: 低確信度時の処理方針は？ → A: 別フォルダ（@review）に出力し、人間確認待ち
- Q: 内容の見直し範囲は？ → A: 冗長な表現の簡潔化、不完全な文の補完

## User Scenarios & Testing *(mandatory)*

### User Story 1 - タイトル品質の改善 (Priority: P1)

ユーザーが @index にファイルを投入し、ローカルLLMで整理したとき、生成されるタイトルがClaude Opusレベルの品質（自然で読みやすく、内容を適切に表現）になっている。

**Why this priority**: タイトルはファイル名として使用されるため、検索性・ナビゲーション・ナレッジベースの整理において最も重要な要素。タイトルが不適切だと他の品質向上が無意味になる。

**Independent Test**: 10件のサンプルファイルを処理し、生成されたタイトルをClaude Opusで生成したタイトルと比較評価できる。タイトル品質だけで独立した価値を提供する。

**Acceptance Scenarios**:

1. **Given** 技術文書（コード例やシステム設計の説明を含む）がある, **When** ローカルLLMで処理する, **Then** 技術用語を適切に含み、内容を明確に表現するタイトルが生成される（例: "MySQL Online DDL の仕組みと注意点"）
2. **Given** 日本語と英語が混在する文書がある, **When** ローカルLLMで処理する, **Then** 文書の主言語に合わせた自然なタイトルが生成される
3. **Given** 曖昧なタイトルや日付プレフィックスのみのファイルがある, **When** ローカルLLMで処理する, **Then** 内容に基づいた説明的なタイトルが生成される

---

### User Story 2 - メタタグ（tags）の品質向上 (Priority: P2)

生成されるタグが一貫性があり、ナレッジベース全体で検索・フィルタリングに有用な形で付与される。

**Why this priority**: タグはObsidianでの横断検索やグラフビューでの関連付けに使用される。タイトルに次いで重要だが、タイトルがなければタグの価値も発揮されない。

**Independent Test**: 20件のファイルを処理し、タグの一貫性（同じ概念に同じタグ）と網羅性（重要なトピックがカバーされている）を評価できる。

**Acceptance Scenarios**:

1. **Given** プログラミング言語に関する文書がある, **When** ローカルLLMで処理する, **Then** 言語名（Python, JavaScript等）と関連技術（Django, React等）が適切にタグ付けされる
2. **Given** 複数のトピックにまたがる文書がある, **When** ローカルLLMで処理する, **Then** 3〜5個の適切な粒度のタグが付与され、過剰なタグ付けは避けられる
3. **Given** 既存のナレッジベースで使用されているタグ語彙がある, **When** 新しいファイルを処理する, **Then** 既存のタグと一貫した語彙が使用される（自動抽出されたタグ辞書を参照）

---

### User Story 3 - Markdownフォーマットの正規化 (Priority: P3)

出力されるMarkdownファイルがObsidian規約に従い、読みやすく一貫したフォーマットになっている。

**Why this priority**: フォーマットの一貫性はナレッジベースの可読性と保守性に影響するが、タイトルやタグが正しければ基本的な機能は果たせる。

**Independent Test**: フォーマット処理のみをテストし、見出しレベル・空行・箇条書きの一貫性を検証できる。

**Acceptance Scenarios**:

1. **Given** 不規則な見出しレベル（#から始まるファイル）がある, **When** ルールベース後処理を適用する, **Then** ##から始まる適切な見出し階層に正規化される
2. **Given** 連続する空行が多数あるファイルがある, **When** ルールベース後処理を適用する, **Then** 空行は最大1行に圧縮される
3. **Given** 混在した箇条書き記号（*、-、+）があるファイルがある, **When** ルールベース後処理を適用する, **Then** 統一された箇条書き記号（-）に正規化される

---

### User Story 4 - コンテンツの精査・改善 (Priority: P2)

原文の内容を精査し、冗長な表現を簡潔にし、不完全な文を補完する。また、日本語以外で書かれた断片的なメモは日本語に書き直す（完全な英語文書は保持）。

**Why this priority**: ナレッジベースの可読性と検索性に直結する。タイトル・タグが正しくても、内容が読みにくければ価値が半減する。

**Independent Test**: 冗長な文書、不完全なメモ、英語混じりの文書を処理し、改善されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 冗長な表現を含む文書がある, **When** ローカルLLMで処理する, **Then** 簡潔で読みやすい表現に書き直される
2. **Given** 途中で終わっている不完全な文がある, **When** ローカルLLMで処理する, **Then** 文脈から適切に補完される
3. **Given** 日英混在の断片的なメモがある, **When** ローカルLLMで処理する, **Then** 自然な日本語に統一される
4. **Given** 完全に英語で書かれた技術文書がある, **When** ローカルLLMで処理する, **Then** 英語のまま保持される（翻訳しない）
5. **Given** コードスニペットを含む文書がある, **When** ローカルLLMで処理する, **Then** コードは保持し、説明部分のみ改善される

---

### Edge Cases

- 内容が極端に短い（1-2行）ファイルでも意味のあるタイトルを生成できるか？
- 複数言語（日英中など）が混在するファイルをどう処理するか？
- 既存のfrontmatterが一部正しく一部不正確な場合にどう扱うか？
- 技術略語や専門用語のみのファイル名をどう解釈するか？
- 英語文書と英語メモの判別基準は何か？（文書構造、長さ、完成度）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはファイル内容を分析し、内容を適切に表現するタイトルを生成する（ファイル名として使用可能な形式）
- **FR-002**: システムは生成するタイトルにファイルシステム禁止文字を含めない
- **FR-003**: システムは3〜5個の適切なタグをfrontmatterに付与する
- **FR-004**: システムは既存ナレッジベースからタグを自動抽出し、処理時にプロンプトへ注入することでタグ語彙の一貫性を維持する
- **FR-005**: システムはルールベースの後処理でMarkdown本文を正規化する（見出し##開始、空行圧縮、箇条書き統一）
- **FR-006**: システムは品質評価メトリクスを出力し、処理結果の品質を確認可能にする
- **FR-007**: システムは処理前後の比較（diff）を確認可能な形式で出力できる
- **FR-008**: システムはLLM出力に対して後処理（正規表現ベースの修正、フォーマット統一）を適用する
- **FR-009**: システムは冗長な表現を簡潔に書き直す
- **FR-010**: システムは不完全な文を文脈から適切に補完する
- **FR-011**: システムは断片的な英語コンテンツを日本語に書き直す（完全な英語文書は保持）
- **FR-012**: システムは文書が「完全な英語文書」か「断片的なメモ」かを判定する基準を持つ
- **FR-013**: システムは確信度が閾値（0.7）未満の場合、@reviewフォルダに出力し人間確認を待つ
- **FR-014**: @reviewフォルダのファイルには確信度と判定理由をfrontmatterに記録する

### Key Entities

- **ファイル**: 処理対象のMarkdownファイル。ファイル名、frontmatter、本文から構成される
- **タイトル**: frontmatter内のtitleフィールド。ファイル名としても使用される
- **タグ**: frontmatter内のtagsフィールド。Obsidianの検索・フィルタリングで使用される
- **ジャンル**: ファイルの分類カテゴリ（エンジニア、ビジネス、経済、日常、その他、dust）
- **品質スコア**: 処理結果の品質を定量的に評価する指標
- **タグ辞書**: 既存ナレッジベースのfrontmatterから自動抽出されたタグ語彙リスト。処理実行時に動的生成され、プロンプトに注入される
- **言語判定**: 文書の主言語と完成度を判定する基準（完全な英語文書 vs 断片的メモ）
- **@reviewフォルダ**: 確信度が低いファイルの一時保管場所。人間による確認・修正後、適切なVaultへ移動される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 生成されたタイトルの70%以上が、内容を正確に表現していると人間が評価できる
- **SC-002**: 同一トピックのファイルに付与されるタグの一貫性が80%以上である
- **SC-003**: Markdownフォーマットの規約違反が処理後に0件になる
- **SC-004**: 処理時間はファイルあたり30秒以内である
- **SC-005**: プロンプト改善と後処理の組み合わせにより、Claude Opus処理結果の70%同等の品質を達成する
- **SC-006**: 断片的な英語メモの90%以上が自然な日本語に書き直される
- **SC-007**: 冗長な表現・不完全な文を含むファイルの80%以上が改善される

## Assumptions

- ローカルLLMは現在のgpt-oss:20bモデルを引き続き使用する（モデル変更は本機能スコープ外）
- 品質向上はプロンプトエンジニアリングと後処理ルールの組み合わせで達成する
- 品質評価は主に人間の主観評価とClaude Opusとの比較で行う
- 既存のollama_normalizer.pyスクリプトを改善する形で実装する
- Obsidian規約（CLAUDE.md記載）に従った正規化を行う
- タグ辞書は各Vault（エンジニア、ビジネス、経済、日常、その他）のファイルから自動抽出する
- Markdownフォーマット正規化はLLMではなくルールベース（正規表現等）で処理する
- 「完全な英語文書」の判定基準: 見出し構造がある、一定以上の長さ、文法的に完成している
