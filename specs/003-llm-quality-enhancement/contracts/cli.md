# CLI Interface Specification

**Date**: 2026-01-11
**Feature**: 003-llm-quality-enhancement

---

## Overview

`ollama_normalizer.py`ã®CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä»•æ§˜ã€‚æ—¢å­˜ã‚³ãƒãƒ³ãƒ‰ã‚’ç¶­æŒã—ã¤ã¤ã€æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ã€‚

---

## Commands

### 1. Single File Processing

```bash
python3 ollama_normalizer.py <file_path>
```

**Arguments**:
- `file_path`: å‡¦ç†å¯¾è±¡ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

**Options**:
- `--json`: çµæœã‚’JSONå½¢å¼ã§å‡ºåŠ›
- `--quiet, -q`: é€²æ—è¡¨ç¤ºã‚’æŠ‘åˆ¶
- `--preview`: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®ç§»å‹•ã¯è¡Œã‚ãªã„ï¼‰

**Output**:
```
âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†å®Œäº†
  ğŸ“„ å…ƒãƒ•ã‚¡ã‚¤ãƒ«: /path/to/file.md
  ğŸ“‚ ç§»å‹•å…ˆ: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢/ã‚¿ã‚¤ãƒˆãƒ«.md
  ğŸ·ï¸ ã‚¸ãƒ£ãƒ³ãƒ«: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ (confidence: 0.85)
  âœ¨ æ”¹å–„: å†—é•·è¡¨ç¾ã‚’ç°¡æ½”åŒ–, è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«èª¿æ•´
```

**Exit Codes**:
- 0: æˆåŠŸ
- 1: ã‚¨ãƒ©ãƒ¼

---

### 2. Batch Processing

```bash
python3 ollama_normalizer.py --all [options]
```

**Options**:
- `--all`: @indexå†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
- `--preview`: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰
- `--json`: JSONå½¢å¼ã§å‡ºåŠ›
- `--quiet, -q`: é€²æ—è¡¨ç¤ºæŠ‘åˆ¶
- `--reset`: å‡¦ç†çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

**Session Control**:
- `--new`: æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆæ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å±¥æ­´ã¨ã—ã¦ä¿æŒï¼‰
- `--resume`: ä¸­æ–­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¶šè¡Œ

**Output**:
```
============================================================
  å‡¦ç†é–‹å§‹: 25 ãƒ•ã‚¡ã‚¤ãƒ«
============================================================

[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 15/25 (60.0%)

============================================================
  ğŸ“Š å‡¦ç†çµæœã‚µãƒãƒªãƒ¼
============================================================
  âœ… æˆåŠŸ: 18 ãƒ•ã‚¡ã‚¤ãƒ«
  ğŸ” è¦ç¢ºèª(@review): 3 ãƒ•ã‚¡ã‚¤ãƒ«
  ğŸ—‘ï¸ Dust: 2 ãƒ•ã‚¡ã‚¤ãƒ«
  âŒ ã‚¨ãƒ©ãƒ¼: 2 ãƒ•ã‚¡ã‚¤ãƒ«
============================================================
```

---

### 3. Status Check

```bash
python3 ollama_normalizer.py --status
```

**Output**:
```
ğŸ“‹ å‡¦ç†çŠ¶æ…‹:
  ã‚»ãƒƒã‚·ãƒ§ãƒ³: 20260111_143000
  é–‹å§‹æ™‚åˆ»: 2026-01-11T14:30:00
  æœ€çµ‚æ›´æ–°: 2026-01-11T14:45:30
  ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 25
  å‡¦ç†æ¸ˆã¿: 15
  æ®‹ã‚Š: 10
  ã‚¨ãƒ©ãƒ¼: 0

â³ æœªå‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«:
    - file1.md
    - file2.md
    ...
```

---

### 4. Tag Dictionary Management (æ–°è¦)

```bash
python3 tag_extractor.py [options]
```

**Options**:
- `--output, -o`: å‡ºåŠ›å…ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `.claude/scripts/data/tag_dictionary.json`ï¼‰
- `--limit`: å„ã‚«ãƒ†ã‚´ãƒªã®æœ€å¤§ã‚¿ã‚°æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30ï¼‰
- `--vaults`: å¯¾è±¡Vaultï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å…¨Vaultï¼‰
- `--json`: JSONå½¢å¼ã§å‡ºåŠ›

**Output**:
```
ğŸ“Š ã‚¿ã‚°è¾æ›¸æŠ½å‡ºå®Œäº†
  è¨€èª: 25 ã‚¿ã‚° (rails, ruby, golang, ...)
  ã‚¤ãƒ³ãƒ•ãƒ©: 20 ã‚¿ã‚° (aws, docker, linux, ...)
  ãƒ„ãƒ¼ãƒ«: 15 ã‚¿ã‚° (git, bash, vim, ...)
  æ¦‚å¿µ: 18 ã‚¿ã‚° (security, setup, ...)
  æ—¥å¸¸: 8 ã‚¿ã‚° (è©±ã—æ–¹, æ—…è¡Œ, ...)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  åˆè¨ˆ: 86 ã‚¿ã‚°
  å‡ºåŠ›: .claude/scripts/data/tag_dictionary.json
```

---

### 5. Markdown Normalization (æ–°è¦)

```bash
python3 markdown_normalizer.py <file_path> [options]
```

**Options**:
- `--output, -o`: å‡ºåŠ›å…ˆï¼ˆæŒ‡å®šãªã—ã§æ¨™æº–å‡ºåŠ›ï¼‰
- `--in-place, -i`: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥æ›´æ–°
- `--diff`: å¤‰æ›´ç®‡æ‰€ã‚’diffå½¢å¼ã§è¡¨ç¤º

**Output** (diff mode):
```diff
--- before
+++ after
@@ -1,5 +1,5 @@
-# ã‚¿ã‚¤ãƒˆãƒ«
+## ã‚¿ã‚¤ãƒˆãƒ«

-* é …ç›®1
-* é …ç›®2
+- é …ç›®1
+- é …ç›®2
```

---

## JSON Output Schemas

### Single File Result

```json
{
  "success": true,
  "file": "/path/to/file.md",
  "genre": "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢",
  "confidence": 0.85,
  "destination": "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢/ã‚¿ã‚¤ãƒˆãƒ«.md",
  "improvements": ["å†—é•·è¡¨ç¾ã‚’ç°¡æ½”åŒ–", "è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«èª¿æ•´"],
  "error": null,
  "timestamp": "2026-01-11T14:30:00"
}
```

### Batch Processing Summary

```json
{
  "total": 25,
  "stats": {
    "success": 18,
    "review": 3,
    "dust": 2,
    "error": 2
  },
  "results": [
    { "file": "...", "success": true, ... },
    ...
  ]
}
```

### Tag Dictionary

```json
{
  "languages": ["rails", "ruby", "golang", "javascript"],
  "infrastructure": ["aws", "docker", "linux", "nginx"],
  "tools": ["git", "bash", "vim", "ssh"],
  "concepts": ["security", "setup", "api"],
  "lifestyle": ["è©±ã—æ–¹", "æ—…è¡Œ"],
  "total_count": 86,
  "extracted_at": "2026-01-11T14:00:00",
  "source_vaults": ["ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "ãƒ“ã‚¸ãƒã‚¹", "çµŒæ¸ˆ", "æ—¥å¸¸"]
}
```

---

## Error Handling

### Error Messages

| ã‚³ãƒ¼ãƒ‰ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | å¯¾å‡¦ |
|--------|----------|------|
| E001 | `ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“` | ãƒ‘ã‚¹ã‚’ç¢ºèª |
| E002 | `èª­ã¿å–ã‚Šæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“` | æ¨©é™ã‚’ç¢ºèª |
| E003 | `ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼` | UTF-8ã§ãªã„å¯èƒ½æ€§ |
| E004 | `Ollamaæ¥ç¶šã‚¨ãƒ©ãƒ¼` | Ollamaã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª |
| E005 | `APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ` | å†è©¦è¡Œã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•· |
| E006 | `JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼` | LLMå‡ºåŠ›ãŒä¸æ­£ |
| E007 | `@dustãƒ•ã‚©ãƒ«ãƒ€ã«æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚Š` | @dustç¢ºèªãƒ»å‰Šé™¤ |

### Retry Logic

- APIå‘¼ã³å‡ºã—: æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
- JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: å†è©¦è¡Œãªã—ï¼ˆçµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼‰

---

## Environment Variables

| å¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|------|-----------|------|
| `OLLAMA_URL` | `http://localhost:11434/api/chat` | Ollama APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| `OLLAMA_MODEL` | `gpt-oss:20b` | ä½¿ç”¨ãƒ¢ãƒ‡ãƒ« |
| `OLLAMA_TIMEOUT` | `120` | APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰ |
| `CONFIDENCE_THRESHOLD` | `0.7` | ç¢ºä¿¡åº¦é–¾å€¤ |
