# Feature Specification: Markdownコードブロック閉じ忘れバグ修正

**Feature Branch**: `056-fix-markdown-codeblock`
**Created**: 2026-02-17
**Status**: Draft
**Input**: Issue#18 - extract_knowledge: Markdownコードブロックが閉じられない出力バグ

## 概要

`extract_knowledge` ノードが要約生成時に不正なMarkdownを出力し、コードブロックが閉じられないままファイルが終了する問題を修正する。この問題により、レビュー対象ファイルの表示が途中で切れ、内容確認が困難になっている。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - レビューファイルの正常表示 (Priority: P1)

ユーザーがKedroパイプラインを実行後、`data/07_model_output/review/` 配下のMarkdownファイルをObsidianで開いた際、ファイルの内容が途中で切れることなく、すべてのセクションが正常に表示される。

**Why this priority**: レビュー対象ファイルは圧縮率が低いため手動確認が必要だが、表示が切れると確認作業自体が不可能になる。これは機能の根本的な目的を阻害している。

**Independent Test**: 任意のレビューファイルをMarkdownビューアで開き、「元のコンテンツ」セクションまで正常に表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** extract_knowledgeノードが要約を生成したとき、**When** 出力ファイルをMarkdownパーサーで解析すると、**Then** すべてのコードブロックが正しく開閉されている
2. **Given** LLM応答にコードブロック記法が含まれるとき、**When** 元のコンテンツと結合すると、**Then** 不正なコードブロックのネストが発生しない
3. **Given** 出力ファイルをObsidianで開いたとき、**When** ファイル末尾までスクロールすると、**Then** 「元のコンテンツ」セクションが完全に表示される

---

### User Story 2 - 既存の不正ファイルの特定 (Priority: P2)

ユーザーが既存の出力ファイル群から、コードブロックが不正なファイルを特定し、再処理の対象を把握できる。

**Why this priority**: バグ修正後も過去に生成された不正ファイルが残存するため、それらを特定できることが重要。

**Independent Test**: 検証スクリプトまたはテストで、不正なMarkdown構文を含むファイルを検出できる。

**Acceptance Scenarios**:

1. **Given** 複数の出力ファイルが存在するとき、**When** Markdown構文チェックを実行すると、**Then** 不正なコードブロックを含むファイルがリストアップされる

---

### Edge Cases

- LLM応答自体が不完全なコードブロックを含む場合はどうなるか？
  - → LLM応答内の不完全なコードブロックは修復して閉じる
- コードブロックが深くネストしている場合はどうなるか？
  - → ネストの深さに関わらず、すべてのコードブロックを正しく閉じる
- 元のコンテンツ自体に不正なMarkdownが含まれる場合はどうなるか？
  - → 元のコンテンツは変更せず、追加部分のみ正しいMarkdownを保証する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、LLM要約生成後の出力において、すべてのMarkdownコードブロック（\`\`\`で始まるブロック）を正しく閉じなければならない
- **FR-002**: システムは、「元のコンテンツ」セクションを追加する際に、不正なコードブロック記法を挿入してはならない
- **FR-003**: システムは、LLM応答に含まれる不完全なコードブロックを検出し、閉じタグを補完しなければならない
- **FR-004**: システムは、出力ファイルのMarkdown構文が有効であることを検証しなければならない
- **FR-005**: 既存の出力ロジックとの互換性を維持しつつ、コードブロック処理を改善しなければならない

### Key Entities

- **要約出力（Summary Output）**: LLMが生成した要約テキスト。コードブロックやMarkdown記法を含む可能性がある
- **元のコンテンツ（Original Content）**: 変換前の会話履歴。要約の後に参照用として追加される
- **出力ファイル（Output File）**: 最終的なMarkdownファイル。要約 + 区切り線 + 元のコンテンツの構成

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: パイプライン実行後のすべての出力ファイルで、Markdownコードブロックが正しく閉じられている（不正率0%）
- **SC-002**: レビューファイルがObsidianで最後まで正常に表示される（表示切れ0件）
- **SC-003**: テストスイートでMarkdown構文検証が100%パスする
- **SC-004**: 既存のゴールデンファイルテストが引き続きパスする（回帰なし）

## Assumptions

- LLMの応答形式は現状維持（大幅な変更なし）
- 修正対象は`extract_knowledge`ノードの出力処理部分
- 元のコンテンツ自体のMarkdown修正は本機能のスコープ外
- 既存の不正ファイルの自動修復は本機能のスコープ外（特定のみ対応）

## Out of Scope

- 元のコンテンツ内の既存Markdown不正の修復
- 過去に生成された不正ファイルの自動再生成
- LLMプロンプトの大幅な変更
