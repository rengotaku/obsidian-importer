# Feature Specification: LLM レスポンス形式をマークダウンに変更

**Feature Branch**: `042-llm-markdown-response`
**Created**: 2026-01-30
**Status**: Draft
**Input**: User description: "LLMのレスポンスはJSONではなくマークダウンにする。そのマークダウンをJSON形式に変換して処理させる。（JSON形式にさせるがために出力内容の低下につながることを恐れている）"

## User Scenarios & Testing

### User Story 1 - LLM にマークダウン形式でレスポンスさせる（Priority: P1）

ETL パイプラインの利用者として、LLM（Ollama）への知識抽出リクエストのレスポンス形式を JSON からマークダウンに変更し、LLM が構造的制約に縛られず自然な文章で回答できるようにしたい。これにより、抽出されるタイトル・要約の品質が向上することを期待する。

**Why this priority**: JSON 形式での出力を強制すると、LLM が形式の正確性に注力するあまり内容の質が低下する懸念がある。マークダウン形式にすることで、LLM は内容の質に集中できる。これが本機能の中核的な動機である。

**Independent Test**: LLM プロンプトをマークダウン形式の出力を求めるように変更し、実際に LLM を呼び出して、マークダウン形式のレスポンスが返ることを確認する。

**Acceptance Scenarios**:

1. **Given** 会話データが transform ステージに渡されたとき、**When** LLM に知識抽出を依頼すると、**Then** レスポンスがマークダウン形式（見出し・リスト等）で返される
2. **Given** LLM がマークダウン形式で応答したとき、**When** レスポンスの内容を確認すると、**Then** タイトル・要約・内容が含まれている

---

### User Story 2 - マークダウンレスポンスを構造化データに変換する（Priority: P1）

ETL パイプラインの利用者として、LLM から返されたマークダウン形式のレスポンスを、後続の処理で使用できる構造化データ（辞書型）に変換したい。これにより、既存のパイプライン処理との互換性を維持する。

**Why this priority**: マークダウンで受け取っても、後続の処理（ファイル名生成、frontmatter 作成、タグ割り当て等）には構造化データが必要。マークダウンからの変換が機能しなければ、パイプライン全体が動作しない。

**Independent Test**: サンプルのマークダウンレスポンスを入力として、パーサーが正しく構造化データに変換できることを確認する。

**Acceptance Scenarios**:

1. **Given** LLM から標準的なマークダウンレスポンスが返されたとき、**When** パーサーが処理すると、**Then** タイトル・要約・内容が正しく抽出された構造化データが得られる
2. **Given** マークダウンレスポンスの構造が期待と異なるとき（見出しの欠落等）、**When** パーサーが処理すると、**Then** 可能な限りデータを抽出し、欠落フィールドには安全なデフォルト値を設定する

---

### User Story 3 - 既存パイプラインとの後方互換性を維持する（Priority: P2）

ETL パイプラインの利用者として、レスポンス形式の変更後も既存のインポートフローが正常に動作することを確認したい。transform 以降のステージ（load）に渡されるデータ構造が変わらないことが重要である。

**Why this priority**: 後方互換性がないと、load ステージやファイル出力に影響が及び、既存のセッションやリトライ機能が壊れる可能性がある。

**Independent Test**: 既存のテストスイートを変更後に実行し、全テストが通過することを確認する。

**Acceptance Scenarios**:

1. **Given** マークダウン形式のレスポンスが構造化データに変換されたとき、**When** load ステージに渡されると、**Then** 従来の JSON レスポンス時と同じフォーマットの Markdown ファイルが生成される
2. **Given** 変換後のデータ構造が、**When** 既存のテストで検証されると、**Then** 全テストが通過する

---

### Edge Cases

- LLM がマークダウンではなくプレーンテキストで応答した場合、どう処理するか？
  - レスポンス全体を要約として扱い、タイトルは先頭行から生成、タグは空リストとする
- マークダウンの見出しレベルが期待と異なる場合（`#` ではなく `##` や `###` を使用）
  - 柔軟にパースし、最初に見つかった見出しをタイトルとして使用する
- LLM がコードブロック内にマークダウンを出力した場合（```markdown ... ``` で囲まれた場合）
  - コードブロックのフェンスを除去してからパースする
- レスポンスが空または極端に短い場合
  - エラーとして処理し、リトライ対象とする
- 日本語と英語が混在するレスポンス
  - 言語に関わらず構造（見出し・リスト）でパースし、内容はそのまま保持する

## Requirements

### Functional Requirements

- **FR-001**: システムは LLM への知識抽出リクエストにおいて、マークダウン形式でのレスポンスを要求するプロンプトを使用しなければならない
- **FR-002**: システムは LLM から返されたマークダウンレスポンスをパースし、タイトル・要約・内容を含む構造化データに変換しなければならない
- **FR-003**: マークダウンパーサーは、見出し（`#`）からタイトルを、`## 要約` セクションから要約を、`## 内容` セクションから内容を抽出しなければならない
- **FR-004**: パーサーは、期待される構造と異なるマークダウンを受け取った場合でも、可能な限りデータを抽出し、欠落フィールドにはデフォルト値を設定しなければならない
- **FR-005**: マークダウンがコードブロック（```markdown ... ```）で囲まれている場合、システムはフェンスを自動的に除去してからパースしなければならない
- **FR-006**: 変換後のデータ構造は、従来の JSON レスポンスをパースした結果と同じ形式でなければならない（後方互換性）
- **FR-007**: プロンプトテンプレートは、LLM に対してマークダウンの具体的な構造（見出し・セクション構成）を指示しなければならない

### Key Entities

- **マークダウンレスポンス**: LLM から返されるマークダウン形式のテキスト。見出し・本文・リストで構成される
- **構造化データ（抽出結果）**: パース後のデータ。タイトル（文字列）、要約（文字列）、内容（文字列）を含む
- **プロンプトテンプレート**: LLM に送信するリクエストの雛形。期待するマークダウン構造を指示する

## Success Criteria

### Measurable Outcomes

- **SC-001**: マークダウン形式で受け取ったレスポンスの 95% 以上が、構造化データへの変換に成功する
- **SC-002**: 変換後のデータを使用して生成された Markdown ファイルが、既存のフォーマット検証をすべて通過する
- **SC-003**: LLM の出力品質（要約の情報量・タイトルの適切さ）が、JSON 形式時と同等以上である（目視評価）
- **SC-004**: 既存のテストスイートが変更後も 100% 通過する
- **SC-005**: パース失敗時のフォールバック処理が正常に動作し、パイプライン全体が中断しない

## Clarifications

### Session 2026-01-30

- Q: タグセクションを LLM のマークダウンレスポンスから除外すべきか？ → A: 除外する。マークダウン構造は `# タイトル` + `## 要約` + `## 内容` の 3 セクションのみとし、現行の 3 フィールド構成（title, summary, summary_content）を維持する。

## Assumptions

- LLM（Ollama）はマークダウン形式での出力を自然にサポートしており、プロンプトで指示すれば適切な構造で応答する
- マークダウンのパースは正規表現や文字列処理で十分であり、外部ライブラリは不要である
- 既存の transform ステージの出力インターフェース（構造化データの形式）は変更しない
- JSON 形式の出力を完全に廃止し、マークダウン形式に一本化する（段階的移行ではなく一括切り替え）
- プロンプトで指示するマークダウン構造は固定であり、プロバイダー（Claude, ChatGPT, GitHub）間で共通とする
