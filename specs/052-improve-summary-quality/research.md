# Research: LLM まとめ品質の向上

**Date**: 2026-02-15
**Branch**: `052-improve-summary-quality`

## 1. 現状分析

### 1.1 圧縮率の問題

**サンプル分析（千葉のSwitch2販売実績.md）**:
- 元の会話: ~4,300 文字
- Ollama 出力: ~450 文字（圧縮率 10.3%）
- Claude 出力: ~1,500 文字（圧縮率 35%）

**品質差分**:
| 項目 | Ollama | Claude |
|------|--------|--------|
| 販売パターン分析 | 事実列挙のみ | 理由・背景を含む |
| データソース | 省略 | 明記 |
| 販売台数推移 | なし | 分析あり |
| 入荷サイクル考察 | なし | あり |
| 具体的な推奨 | なし | あり |

### 1.2 現行プロンプトの課題

現在の `knowledge_extraction.txt` は以下を含む:
- 最低文字数の目安（500-1000文字）
- 省略禁止の指示
- 構造化の指示

**不足している要素**:
1. 「なぜ」「理由」を説明する明示的指示
2. 表形式データ検出時の保持指示
3. 分析・推奨セクションの構造化テンプレート
4. 数値・日付の保持を強調する指示

## 2. 改善方針

### 2.1 プロンプト改善

**追加すべき指示**:

```text
## 分析・考察の記述

会話に分析や考察が含まれる場合:
- **理由・背景**: 「なぜそうなるか」を必ず説明
- **パターン・傾向**: データから読み取れる傾向を明記
- **推奨・アドバイス**: 結論だけでなく根拠も記述

## 表形式データの保持

元の会話に表形式データがある場合:
- **必ず Markdown 表形式で保持**
- 数値・日付は省略せず記載
- 表の前に簡潔な説明を追加
```

### 2.2 ゴールデンファイル選定基準

**選定マトリクス**:

| 会話タイプ | 小 (<2KB) | 中 (2-5KB) | 大 (>5KB) |
|-----------|-----------|------------|-----------|
| 技術系 | ✓ | ✓ | ✓ |
| ビジネス系 | ✓ | ✓ | - |
| 日常系 | ✓ | - | - |
| 表形式含む | - | ✓ | ✓ |
| コード含む | ✓ | ✓ | - |

**ソース**:
- organized/: 成功例（圧縮率 OK）
- review/: 改善対象（圧縮率 NG）

### 2.3 検証基準

1. **圧縮率しきい値**:
   - <5000文字: 20%以上
   - 5000-9999文字: 15%以上
   - ≥10000文字: 10%以上

2. **構造保持**:
   - 表形式 → Markdown表が出力に含まれる
   - リスト → 箇条書きが保持される

## 3. 技術的決定

### Decision 1: プロンプト改善アプローチ

**決定**: 既存プロンプトに追加セクションを挿入（破壊的変更可）

**理由**:
- プロジェクト方針で後方互換性不要
- 既存構造を活かしつつ強化
- テスト可能な変更

**代替案（却下）**:
- プロンプト全面書き換え → 既存の良い部分を失うリスク
- モデル変更 → インフラ変更が必要

### Decision 2: ゴールデンファイル配置

**決定**: `tests/fixtures/golden/` に配置

**理由**:
- 既存のテストフィクスチャ構造と整合
- CI で自動実行可能
- CLAUDE.md に存在を追記

**代替案（却下）**:
- specs/ 内に配置 → テストとの分離が困難
- 別リポジトリ → 管理が複雑化

### Decision 3: E2E テスト方式

**決定**: unittest ベースで圧縮率 + 構造保持を検証

**理由**:
- プロジェクト標準の unittest を使用
- 明確な成功/失敗基準
- CI 統合が容易

## 4. ゴールデンファイル候補

### 4.1 organized/ からの候補

| ファイル | サイズ | タイプ | 選定理由 |
|---------|--------|--------|----------|
| API GatewayとLoad Balancerの違い.md | 3.9KB | 技術・中 | 比較分析、構造化 |
| Ubuntu デスクトップショートカット設定.md | 5.2KB | 技術・大 | 手順、コード |
| 9ヶ月赤ちゃんのおやつとバナナプリン.md | 3.1KB | 日常・中 | 一般的な内容 |
| Automatic1111 positive prompt 設定.md | 2.4KB | 技術・小 | 設定、短い |
| AI画像販売とライセンス.md | 3.9KB | ビジネス・中 | ビジネス観点 |

### 4.2 review/ からの候補

| ファイル | サイズ | タイプ | 選定理由 |
|---------|--------|--------|----------|
| 千葉のSwitch2販売実績.md | 12.5KB | 表形式・大 | 表形式、分析 |
| ホームベーカリーでパンが膨らまない原因究明.md | 12.6KB | 日常・大 | 問題解決、考察 |
| Spec駆動開発とコンテキストエンジニアリング.md | 5.4KB | 技術・中 | 概念説明 |
| Claude Code ステータスライン表示問題の解決.md | 9.7KB | 技術・コード | トラブルシュート、コード |

## 5. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| プロンプト変更で他の出力品質が低下 | 中 | ゴールデンファイルでリグレッション検出 |
| Ollama モデルの制限 | 低 | タイムアウト延長で対応（既に 300秒） |
| ゴールデンファイル選定の偏り | 中 | マトリクスで多様性確保 |
