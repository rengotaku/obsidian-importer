# Feature Specification: LLM まとめ品質の向上

**Feature Branch**: `052-improve-summary-quality`
**Created**: 2026-02-15
**Status**: Draft
**Input**: User description: "まとめの向上"

## Clarifications

### Session 2026-02-15

- Q: ゴールデンファイルの選定基準は？ → A: 多様なケース（organized から成功例 + review から改善対象）を各 2-3 件ずつ選定
- Q: ゴールデンファイルの選定カテゴリは？ → A: 会話タイプ × ファイルサイズのマトリクス選定
- Q: ゴールデンファイルの総数は？ → A: 10-12 件（網羅的、全カテゴリを詳細にカバー）
- Q: ゴールデンファイルの配置場所は？ → A: tests/fixtures/golden/ に追加 + CLAUDE.md に追記
- Q: ゴールデンファイルの比較基準は？ → A: 圧縮率 + 構造保持（しきい値達成 & 表/リスト形式の保持を検証）
- Q: 最低文字数は短い会話にも適用？ → A: 動的（元の20%以上 or 300文字以上のいずれか大きい方）
- Q: しきい値の実装方法は？ → A: 検証完了。定性的指示のみで十分（verification-results.md 参照）
- Q: 検証に使用するモデルは？ → A: 本番モデル（gpt-oss:20b）のみ
- Q: プロンプトに数値しきい値を含めるか？ → A: 不要。定性的指示で問題ケースが 7%→24% に改善

## 背景

現在の Kedro パイプラインでは、LLM（Ollama）を使用して会話履歴からナレッジベース用のまとめを生成している。しかし、生成されるまとめが過度に圧縮され、重要な情報が欠落するケースがある。

**現状の問題**:
- 元の会話（約 4,300 文字）に対して、まとめが約 450 文字（圧縮率 10.3%）
- しきい値 20% 未満で review フォルダに振り分けられている
- Claude での再生成では約 1,500 文字（圧縮率 35%）となり、情報の深さが大幅に向上

**比較で判明した差分**:
- 販売パターンの分析詳細（理由の説明）
- データソースの明記
- 販売台数推移の分析
- 入荷サイクルの考察
- 具体的な推奨行動

## User Scenarios & Testing *(mandatory)*

### User Story 1 - まとめ品質の向上 (Priority: P1)

ユーザーは、LLM 会話履歴をインポートする際に、重要な情報が漏れなく抽出され、文脈や理由も含めた有用なまとめを得たい。

**Why this priority**: review フォルダに振り分けられるファイルを減らし、手動レビューの負担を軽減する。パイプラインの実用性を高める最重要課題。

**Independent Test**: テスト会話をパイプラインで処理し、圧縮率が改善され review フォルダへの振り分けが減少することを確認。

**Acceptance Scenarios**:

1. **Given** 5,000 文字未満の会話履歴, **When** extract_knowledge ノードで処理, **Then** 圧縮率 20% 以上のまとめが生成される
2. **Given** 表形式のデータを含む会話, **When** extract_knowledge ノードで処理, **Then** 表形式が保持され、数値・日付が正確に含まれる
3. **Given** 分析や推奨を含む会話, **When** extract_knowledge ノードで処理, **Then** 理由や背景の説明も含まれる

---

### User Story 2 - review フォルダへの振り分け削減 (Priority: P2)

ユーザーは、パイプライン実行後に手動レビューが必要なファイル数を最小限に抑えたい。

**Why this priority**: review フォルダのファイルは手動確認が必要で、大量にあると運用負担が大きい。

**Independent Test**: 同一の入力データセットでパイプラインを実行し、review フォルダへの振り分け率が改善前後で比較可能。

**Acceptance Scenarios**:

1. **Given** 複数の会話を含むインポートデータ, **When** パイプライン全体を実行, **Then** review フォルダへの振り分け率が 20% 以下になる

---

### User Story 3 - ゴールデンファイルによる品質検証 (Priority: P2)

ユーザーは、プロンプト改善後の出力品質をゴールデンファイルと比較して検証したい。

**Why this priority**: 改善の効果を客観的に測定し、リグレッションを防止する。

**Independent Test**: ゴールデンファイルセットに対してパイプラインを実行し、比較基準を満たすことを確認。

**Acceptance Scenarios**:

1. **Given** ゴールデンファイルセット（10-12 件）, **When** パイプラインで処理, **Then** 全ファイルが圧縮率しきい値を満たす
2. **Given** 表形式データを含むゴールデンファイル, **When** パイプラインで処理, **Then** 表/リスト形式が保持される

---

### Edge Cases

- 元の会話が極端に短い場合（1,000 文字未満）、圧縮率のしきい値を緩和する
- コード主体の会話では、コードブロックを適切に保持しつつ解説を追加する
- 多言語が混在する会話では、主要言語でまとめる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、まとめ生成時に「理由や背景も含めて説明する」指示をプロンプトに含めなければならない
- **FR-002**: システムは、まとめの最低文字数を動的に検証しなければならない（元の会話の20%以上 or 300文字以上のいずれか大きい方）。検証はコード側で実施し、プロンプトには定性的指示のみ含める
- **FR-003**: システムは、表形式のデータがある場合、表形式を保持してまとめに含めなければならない
- **FR-004**: システムは、具体的な数値・日付・固有名詞を省略せずにまとめに含めなければならない
- **FR-005**: システムは、元の会話に分析や推奨がある場合、それらを構造化してまとめに含めなければならない
- **FR-006**: システムは、ゴールデンファイルセット（10-12 件）を tests/fixtures/golden/ に保持しなければならない
- **FR-007**: ゴールデンファイルは、会話タイプ（技術、ビジネス、日常、表形式、コード含む）× ファイルサイズ（小/中/大）のマトリクスから選定しなければならない
- **FR-008**: ゴールデンファイルは、organized（成功例）と review（改善対象）の両方から選定しなければならない

### Key Entities

- **プロンプトテンプレート**: knowledge_extraction.txt - まとめ生成の指示を定義
- **圧縮率しきい値**: 元のサイズに応じた動的なしきい値（5,000 文字未満: 20%、5,000-9,999: 15%、10,000 以上: 10%）
- **ゴールデンファイルセット**: tests/fixtures/golden/ に配置される 10-12 件の検証用ファイル

### ゴールデンファイル選定マトリクス

| 会話タイプ | 小 (<2KB) | 中 (2-5KB) | 大 (>5KB) | ソース |
|-----------|-----------|------------|-----------|--------|
| 技術系 | 1 件 | 1 件 | 1 件 | organized + review |
| ビジネス系 | 1 件 | 1 件 | - | organized |
| 日常系 | 1 件 | - | - | organized |
| 表形式データ含む | - | 1 件 | 1 件 | review |
| コード含む | 1 件 | 1 件 | - | organized + review |

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 圧縮率しきい値を満たすファイルの割合が 80% 以上になる（現状から改善）
- **SC-002**: review フォルダへの振り分け率が 20% 以下になる
- **SC-003**: 生成されるまとめが動的しきい値（元の20%以上 or 300文字以上）を満たす
- **SC-004**: 表形式データを含む会話の 90% 以上で、まとめにも表形式が保持される
- **SC-005**: ゴールデンファイルセット（10-12 件）全てが圧縮率しきい値を満たす
- **SC-006**: ゴールデンファイルの比較テストが CI で自動実行される

## Assumptions

- プロンプトの調整により、Ollama モデルの出力品質は改善可能
- 現在使用中のモデル（gemma3:12b / oss-gpt:20b）は十分な能力を持つ
- 処理時間の増加は許容範囲内（タイムアウト設定の調整で対応）
- ゴールデンファイルの選定は data/07_model_output/organized および data/07_model_output/review から行う
