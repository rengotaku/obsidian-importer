# Feature Specification: ETL ジャンル分類の細分化

**Feature Branch**: `058-refine-genre-classification`
**Created**: 2026-02-19
**Status**: Draft
**Input**: Issue#22 - ETL: ジャンル分類の細分化（その他が多すぎる問題）

## 背景

現在の ETL パイプラインのジャンル分類では、「その他 (other)」に分類されるファイルが全体の 67% (209/313件) を占めており、分類の粒度が粗すぎる問題がある。

### 現状の分類結果

| ジャンル | 件数 | 割合 |
|---------|------|------|
| その他 | 210件 | 67% |
| エンジニア | 81件 | 26% |
| 経済 | 8件 | 3% |
| ビジネス | 7件 | 2% |
| 日常 | 7件 | 2% |

### 「その他」に含まれる内容の例

- **AI/ML**: Stable Diffusion, Claude Code, キャラクター生成
- **インフラ/DevOps**: Cloudflare, NGINX, Traefik, Docker
- **Linux/Ubuntu**: Ubuntu設定, Bash, Obsidian
- **家電/生活**: パナソニック空気清浄機, 電子レンジ
- **子育て**: 赤ちゃん連れ旅行, キッザニア
- **旅行**: 宮崎への旅行

## User Scenarios & Testing

### User Story 1 - ジャンル分類の精度向上 (Priority: P1)

ナレッジベース管理者として、ETL パイプラインを実行した際に、ファイルがより詳細なジャンルに分類されることで、後からの検索・整理が容易になる。

**Why this priority**: 「その他」が 67% を占める現状では、ジャンル別整理の意味がほぼない。分類精度の向上がこの機能の核心的価値である。

**Independent Test**: `kedro run` 実行後、`data/07_model_output/organized/` 配下のジャンル別フォルダを確認し、「その他」の割合が減少していることで検証可能。

**Acceptance Scenarios**:

1. **Given** 313件のナレッジファイルがある, **When** ETL パイプラインを実行する, **Then** 「その他」に分類されるファイルが 30% 以下になる
2. **Given** AI/ML関連の会話ファイルがある, **When** ジャンル分類が実行される, **Then** 「ai」ジャンルに正しく分類される
3. **Given** DevOps/インフラ関連の会話ファイルがある, **When** ジャンル分類が実行される, **Then** 「devops」ジャンルに正しく分類される

---

### User Story 2 - 新ジャンルへの適切なマッピング (Priority: P1)

ナレッジベース管理者として、追加された新ジャンルに対して、適切なキーワードがマッピングされていることで、意図したカテゴリにファイルが振り分けられる。

**Why this priority**: 新ジャンル追加だけでは不十分で、正確なキーワードマッピングがなければ分類精度は向上しない。US1と同等に重要。

**Independent Test**: 各新ジャンルに対して、想定されるキーワードを含むテストファイルを用意し、正しいジャンルに分類されることを確認。

**Acceptance Scenarios**:

1. **Given** 「Stable Diffusion」「Claude」などの AI 関連キーワードを含むファイル, **When** 分類実行, **Then** 「ai」ジャンルに分類される
2. **Given** 「Docker」「Kubernetes」「NGINX」などのインフラキーワードを含むファイル, **When** 分類実行, **Then** 「devops」ジャンルに分類される
3. **Given** 「空気清浄機」「電子レンジ」「洗濯機」などの家電キーワードを含むファイル, **When** 分類実行, **Then** 「lifestyle」ジャンルに分類される
4. **Given** 「子育て」「赤ちゃん」「キッザニア」などの育児キーワードを含むファイル, **When** 分類実行, **Then** 「parenting」ジャンルに分類される

---

### User Story 3 - 既存分類との後方互換性 (Priority: P2)

ナレッジベース管理者として、既存の4ジャンル（engineer, business, economy, daily）の分類結果が維持されることで、以前に分類したファイルの整合性が保たれる。

**Why this priority**: 新ジャンル追加により既存分類が壊れると、過去の整理作業が無駄になる。ただし、新ジャンルで捕捉されるべきファイルが既存ジャンルから移動することは許容される。

**Independent Test**: 既存の4ジャンルのキーワードを含むテストファイルを用意し、従来通りの分類結果になることを確認。

**Acceptance Scenarios**:

1. **Given** 「プログラミング」「API」などの技術キーワードを含むファイル, **When** 分類実行, **Then** 「engineer」ジャンルに分類される（従来通り）
2. **Given** 「投資」「金融」などの経済キーワードを含むファイル, **When** 分類実行, **Then** 「economy」ジャンルに分類される（従来通り）
3. **Given** 既存テストスイートを実行, **When** 全テスト完了, **Then** テストがすべてパスする

---

### Edge Cases

- 複数ジャンルにまたがるキーワードを含むファイル（例: 「AI 投資」）はどうなるか？ → 優先度の高いジャンルが適用される（priority order）
- 日本語と英語が混在するキーワードは両方認識されるか？ → 両方をキーワードリストに含める
- タグと本文で異なるジャンルが示唆される場合は？ → タグ優先（既存ロジック維持）
- 「その他」に残るべきファイルは？ → 単発の雑多な話題、複合トピック（複数ジャンルにまたがり優先度で決められないもの）、分類困難なコンテンツ。30%以下を目標とするが、0%を目指す必要はない

## Requirements

### Functional Requirements

- **FR-001**: システムは新しいジャンル（ai, devops, lifestyle, parenting, travel, health）を認識できること
- **FR-002**: 各新ジャンルに対して、適切なキーワードセットが定義されていること
- **FR-003**: ジャンル分類は既存の優先度順序ロジック（タグ優先、first match wins）を維持すること
- **FR-004**: 新ジャンルは `conf/base/parameters.yml` の `genre_keywords` セクションに追加されること
- **FR-005**: `data/07_model_output/organized/` 配下に新ジャンル用のフォルダが作成されること
- **FR-006**: 新ジャンル追加後も既存テストがすべてパスすること
- **FR-007**: CLAUDE.md のジャンル説明が新ジャンルを反映して更新されること
- **FR-008**: パイプライン完了時にジャンル分布（各ジャンルの件数・割合）がログ出力されること

### Key Entities

- **Genre**: 分類カテゴリ（全11種）
  - `ai`: AI/ML、生成AI、機械学習
  - `devops`: インフラ、クラウド、CI/CD、コンテナ
  - `engineer`: プログラミング、アーキテクチャ、一般的な技術
  - `economy`: 投資、金融、経済ニュース
  - `business`: ビジネス、マネジメント、キャリア
  - `health`: 健康、医療、フィットネス
  - `parenting`: 子育て、育児、教育
  - `travel`: 旅行、観光
  - `lifestyle`: 家電、生活用品、住居、DIY
  - `daily`: 日記、雑記、感想、趣味
  - `other`: 上記に該当しない雑多なコンテンツ
- **Keyword**: ジャンル判定に使用するキーワード（日本語/英語）
- **Priority**: ジャンルの判定優先順位

## Success Criteria

### Measurable Outcomes

- **SC-001**: 「その他」に分類されるファイルの割合が 30% 以下に減少する
- **SC-002**: 新ジャンル（ai, devops, lifestyle, parenting, travel, health）が正しく認識され、ファイルが振り分けられる
- **SC-003**: 既存の4ジャンル（engineer, business, economy, daily）の分類精度が維持される（既存テスト全パス）
- **SC-004**: パイプライン実行時間が現状から 10% 以上増加しない

## Clarifications

### Session 2026-02-19

- Q: 新ジャンル追加後も「その他」に残るべきファイルは何か？ → A: 「その他」は30%以下で許容。単発の雑多な話題、複合トピック、分類困難なものを含む正当なカテゴリとして維持
- Q: 分類方式は優先度順（単一ジャンル）かマルチラベルか？ → A: 優先度順で進める。情報損失は許容し、シンプルさを優先
- Q: `lifestyle` と `daily` の境界は？ → A: `daily` = 日記・雑記・感想、`lifestyle` = 家電・生活用品・住居・DIY
- Q: 将来「その他」が増えた場合の調整フローは？ → A: 下記「運用・保守」セクションに定義
- Q: 運用上の制約は？ → A: インポート後にソースファイル削除、四半期レビュー不可。検知はインポート実行時のログで行う
- Q: ジャンル分布の確認方法は？ → A: パイプライン完了時にジャンル分布（件数・割合）をログ出力

## 運用・保守

### 運用制約

- **ソースファイル削除**: インポート処理後、元ファイルは削除される
- **定期レビュー不可**: 四半期ごとの整理は運用上見込めない

### ジャンル調整フロー

将来「その他」の割合が増加した場合の対応手順：

#### 1. 検知（トリガー条件）

- **インポート実行時**: パイプライン完了後のログ出力で「その他」の割合を確認
- 「その他」の割合が **40% を超えた**場合、調整を検討

#### 2. 分析

1. Obsidian Vault 内の `organized/other/` フォルダを確認（インポート済みファイル）
2. 共通するトピック・キーワードを特定
3. 既存ジャンルへの追加キーワードで対応可能か判断

#### 3. 対応方針の決定

| 状況 | 対応 |
|------|------|
| 既存ジャンルのキーワード不足 | `parameters.yml` にキーワード追加 |
| 新しいトピック領域の出現 | 新ジャンル追加を検討（Issue 作成） |
| 雑多で分類困難 | 「その他」のまま許容 |

#### 4. 実装

- キーワード追加のみ: `conf/base/parameters.yml` を編集
- 新ジャンル追加: 本仕様と同様のプロセスで Issue を作成し、仕様策定から実施

#### 5. 検証

- 次回インポート時に「その他」が 30% 以下になることを確認
- 既存 Vault 内ファイルの再分類が必要な場合は手動で移動

## Assumptions

- キーワードマッチングベースの分類（LLM 不使用）を継続する
- **単一ジャンル方式**: 各ファイルは1つのジャンルのみに分類される（マルチラベルは採用しない）
- ジャンルの優先順位は設定可能（parameters.yml で順序定義）
- 既存の `classify_genre` 関数を拡張する（新関数作成ではなく）
- 優先順位のデフォルト: ai → devops → engineer → economy → business → health → parenting → travel → lifestyle → daily → other
- 複数ジャンルにまたがるコンテンツは優先度の高いジャンルに分類される（情報損失は許容）
