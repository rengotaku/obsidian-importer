# Feature Specification: レビューファイル対象の割合削減

**Feature Branch**: `055-reduce-review-ratio`
**Created**: 2026-02-17
**Status**: Draft
**Input**: GitHub Issue #17 - reviewファイル対象の割合を減少させる

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - レビュー理由の分類と可視化 (Priority: P1)

ナレッジベース管理者として、レビュー対象ファイルがなぜレビューに振り分けられたのかを分類・可視化したい。なぜなら、問題の傾向を把握することで、改善すべき優先順位を決定できるからだ。

**Why this priority**: 現状把握なくして改善はできない。まずデータを分類・可視化することが全ての基盤となる。

**Independent Test**: レビューファイルの `review_reason` を集計し、カテゴリ別の件数と割合を出力できる。

**Acceptance Scenarios**:

1. **Given** レビューフォルダに79件のファイルがある場合, **When** 分類レポートを実行する, **Then** カテゴリ別（空コンテンツ、タイムアウト、低body_ratio等）の件数と割合が表示される
2. **Given** 低body_ratioのファイル群がある場合, **When** 分類レポートを実行する, **Then** 閾値別（10%、15%、20%）のサブ分類が表示される
3. **Given** 分類レポートが実行された場合, **When** 結果を確認する, **Then** 各カテゴリの代表的なファイル名が3件ずつ表示される

---

### ユーザーストーリー 2 - 妥当性検証用ゴールデンファイルの作成 (Priority: P1)

ナレッジベース管理者として、レビュー判定の妥当性を検証するためのゴールデンファイル（正解データ）を作成したい。なぜなら、閾値調整やLLM改善の効果を客観的に評価する基準が必要だからだ。

**Why this priority**: 改善の効果を測定するには、事前に「これは本当にレビュー必要」「これは不要」という基準データが必要。

**Independent Test**: 各review_reasonカテゴリから代表サンプルを選定し、人間がレビュー要否を判定したゴールデンファイルを作成できる。

**Acceptance Scenarios**:

1. **Given** 各カテゴリから代表サンプルを選定する場合, **When** サンプル選定を実行する, **Then** 各カテゴリから最低3件、合計15件以上のサンプルが選定される
2. **Given** サンプルファイルが選定された場合, **When** 人間が妥当性を判定する, **Then** 各ファイルに「review_required: true/false」と判定理由が記録される
3. **Given** ゴールデンファイルが作成された場合, **When** 将来の改善後に同じファイルを再処理する, **Then** 判定精度（適合率・再現率）が計算できる

---

### ユーザーストーリー 3 - 閾値の最適化 (Priority: P2)

ナレッジベース管理者として、body_ratio閾値を最適化して、品質を保ちながらレビュー対象を削減したい。なぜなら、現在の閾値（10%/15%/20%）が最適とは限らず、調整によりレビュー負担を軽減できる可能性があるからだ。

**Why this priority**: ゴールデンファイルによる妥当性検証後、データに基づいた閾値調整が可能になる。

**Independent Test**: 閾値を変更してパイプラインを再実行し、レビュー件数と品質のトレードオフを確認できる。

**Acceptance Scenarios**:

1. **Given** ゴールデンファイルで「review不要」と判定されたファイル群がある場合, **When** それらのbody_ratioを分析する, **Then** 新しい推奨閾値が算出される
2. **Given** 新しい閾値を設定した場合, **When** パイプラインを再実行する, **Then** レビュー件数が現在の79件から減少する
3. **Given** 閾値変更後, **When** ゴールデンファイルで検証する, **Then** 偽陰性（本来レビュー必要なのにorganizedに出力）が5%未満に抑えられる

---

### ユーザーストーリー 4 - LLM品質改善による空コンテンツ削減 (Priority: P2)

ナレッジベース管理者として、LLMが空コンテンツを返す頻度を削減したい。なぜなら、空コンテンツは最も多いレビュー理由（17件）であり、これを改善すればレビュー対象が大幅に減るからだ。

**Why this priority**: 空コンテンツ（17件）は全レビューファイルの約22%を占める主要な問題。

**Independent Test**: 空コンテンツでレビューに振り分けられたファイルを再処理し、正常にコンテンツが抽出される件数が増加することを確認できる。

**Acceptance Scenarios**:

1. **Given** 空コンテンツでレビューされた17件がある場合, **When** 原因を分析する, **Then** 元の会話が短すぎる/価値がない/LLMが処理できないなどの原因が特定される
2. **Given** LLM処理改善後, **When** 同じファイルを再処理する, **Then** 空コンテンツの発生率が50%以上削減される
3. **Given** 空コンテンツの原因が「元の会話に価値がない」場合, **When** 適切なフィルタリングを行う, **Then** そもそも処理対象から除外される

---

### エッジケース

- レビュー理由が複合的（body_ratio低い + タイトルに問題あり）な場合 → 主要な理由のみ記録、複合フラグを追加
- ゴールデンファイルで判断が分かれる境界ケース → 複数人で判定し、合意形成
- 閾値変更により以前はorganizedだったファイルがreviewに移動する場合 → 変更前後の差分レポートを出力
- 全件がreview不要と判定された場合 → 閾値が緩すぎる可能性を警告

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはレビューファイルのreview_reasonをカテゴリ別に集計できなければならない
- **FR-002**: システムは各カテゴリの件数と全体に対する割合を表示しなければならない
- **FR-003**: システムはbody_ratioによるレビューを閾値別にサブ分類できなければならない
- **FR-004**: 管理者はゴールデンファイルを作成し、レビュー要否の正解データを記録できなければならない
- **FR-005**: システムはゴールデンファイルに基づいて判定精度（適合率・再現率）を計算できなければならない
- **FR-006**: 管理者はbody_ratio閾値を設定ファイルで変更できなければならない
- **FR-007**: システムは閾値変更前後のレビュー件数差分を報告しなければならない
- **FR-008**: 空コンテンツレビューの原因分析レポートを出力できなければならない

### 主要エンティティ

- **ReviewFile**: レビュー対象ファイル。file_id, title, review_reason, review_node を持つ
- **ReviewCategory**: レビュー理由のカテゴリ。name, count, percentage, sample_files を持つ
- **GoldenFile**: 妥当性検証用の正解データ。file_id, review_required (boolean), judgment_reason を持つ
- **ThresholdConfig**: 閾値設定。small_threshold, medium_threshold, large_threshold を持つ

## 成功基準 *(必須)*

### 計測可能な成果

- **SC-001**: レビューファイルの割合が現在の22%（79/361件）から15%以下に削減される
- **SC-002**: ゴールデンファイルに基づく判定精度（再現率）が95%以上を維持する
- **SC-003**: 空コンテンツによるレビューが現在の17件から8件以下に削減される
- **SC-004**: 閾値ギリギリでレビューに振り分けられたファイル（閾値の90-100%範囲）のうち、80%以上が「review不要」と判定される
- **SC-005**: レビュー分類レポートの実行が30秒以内で完了する
- **SC-006**: ゴールデンファイルの作成・更新フローが文書化される

## 背景調査

### 現状分析（Issue #17 より）

| 指標 | 現在値 |
|------|--------|
| organized件数 | 282件 |
| review件数 | 79件 |
| レビュー割合 | 約22% |

### review_reason分類

| カテゴリ | 件数 | 割合 | 備考 |
|----------|------|------|------|
| 空コンテンツ | 17件 | 21.5% | LLM returned empty summary_content |
| タイムアウト | 5件 | 6.3% | Timeout (120s) |
| body_ratio < 10% | 約40件 | 50.6% | 小サイズファイル |
| body_ratio < 15% | 約10件 | 12.7% | 中サイズファイル |
| body_ratio < 20% | 約7件 | 8.9% | 大サイズファイル |

### 閾値ギリギリのケース

- 9.7% → 閾値10%: あと0.3%でorganized
- 14.9% → 閾値15%: あと0.1%でorganized
- 19.8% → 閾値20%: あと0.2%でorganized

これらのギリギリケースは、閾値調整の主要なターゲットとなる。

### 小サイズファイル圧縮率検証結果（clarify実施）

| ファイル | ジャンル | body_ratio | 元サイズ | 判定 |
|----------|----------|------------|----------|------|
| 1日のスケジュール調整.md | 育児/スケジュール | 4.2% | 16,890字 | レビュー不要 |
| AWS Backupによるランサムウェア対策.md | AWS/セキュリティ | 8.9% | 5,091字 | レビュー不要 |
| MySQLのMVCCとトランザクション分離レベル.md | MySQL/DB | 6.9% | 4,825字 | レビュー不要 |
| Shopifyカートボタンのスタイル変更.md | Shopify/CSS | 6.3% | 4,697字 | レビュー不要 |
| Serena と Claude Code の統合.md | Claude Code/MCP | 8.6% | 9,350字 | レビュー不要 |

**検証結論**: 5件中5件がレビュー不要と判定。現在の10%閾値は厳しすぎる可能性が高い。会話形式の元データは冗長性が高く、適切に要約すると必然的に圧縮率が低くなる。

**推奨**: 閾値を5-7%に緩和することで、品質良好なファイルをorganizedに振り分け可能。

## 前提条件

- 既存のreviewファイルは再処理により改善できる可能性がある
- ゴールデンファイルの作成は人間の判断が必要
- 閾値調整は設定ファイルで行い、コード変更は不要とする
- LLM品質改善は054-output-quality-improveと連携する可能性がある
- 「レビュー不要」の判定基準は「内容が正確に要約されており、ファイルとして価値がある」とする
