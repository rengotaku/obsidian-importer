# Feature Specification: @index フォルダ内再帰的Markdown処理

**Feature Branch**: `006-index-markdown-process`
**Created**: 2026-01-12
**Status**: Draft
**Input**: User description: "@indexのフォルダに含まれるMarkdownも処理してほしい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - サブフォルダ内Markdown一括処理 (Priority: P1)

ユーザーが`@index/`フォルダにサブフォルダ構造でMarkdownファイルを保存している場合、既存の「整理して」コマンドでサブフォルダ内のファイルも自動的に検出・処理される。

**Why this priority**: 最も基本的な要求であり、サブフォルダ内のMarkdownが処理されないと整理漏れが発生し、ナレッジベースの整合性が損なわれる。

**Independent Test**: `@index/subfolder/test.md`を作成し、「整理して」コマンドを実行。ファイルが適切なVaultに移動されることを確認。

**Acceptance Scenarios**:

1. **Given** `@index/claude/会話ログ.md`が存在する, **When** 「整理して」コマンドを実行, **Then** ファイルの内容に基づき適切なVault（例：エンジニア/）に移動される
2. **Given** `@index/import/2024-01/メモ.md`のように深い階層にファイルがある, **When** 「整理して」コマンドを実行, **Then** 階層の深さに関係なくファイルが検出・処理される
3. **Given** `@index/`直下のファイルとサブフォルダ内ファイルが混在, **When** 「整理して」コマンドを実行, **Then** すべてのMarkdownファイルが処理される

---

### User Story 2 - 処理対象ファイルのプレビュー表示 (Priority: P2)

ユーザーが処理前に対象ファイルを確認でき、想定外のファイルが含まれていないか検証できる。

**Why this priority**: 大量のファイルを一括処理する際、誤って重要なファイルを移動してしまうリスクを軽減する。P1の基本機能の後に実装可能。

**Independent Test**: 「整理して」コマンド実行前に対象ファイル一覧を表示し、ユーザーが確認後に続行/中止を選択できることを確認。

**Acceptance Scenarios**:

1. **Given** `@index/`以下に10個のMarkdownファイルが存在, **When** 「整理して」コマンドを実行, **Then** 処理前に対象ファイルの一覧（ファイル名、現在パス、検出されたジャンル）が表示される
2. **Given** プレビュー一覧が表示された状態, **When** ユーザーが続行を選択, **Then** 処理が実行される
3. **Given** プレビュー一覧が表示された状態, **When** ユーザーが中止を選択, **Then** 処理がキャンセルされファイルは移動されない

---

### User Story 3 - 特定フォルダの除外設定 (Priority: P3)

ユーザーが特定のサブフォルダを処理対象から除外でき、作業中のファイルや特殊な用途のフォルダを保護できる。

**Why this priority**: 基本機能（P1）と確認機能（P2）の後に、より高度な制御として実装可能。初期リリースでは除外パターンのデフォルト設定で対応。

**Independent Test**: 除外設定済みの`@index/wip/`フォルダ内にファイルを配置し、「整理して」実行後もファイルが移動されないことを確認。

**Acceptance Scenarios**:

1. **Given** `@index/wip/draft.md`があり、`wip`フォルダが除外対象, **When** 「整理して」コマンドを実行, **Then** `draft.md`は処理対象から除外される
2. **Given** 除外設定がない状態, **When** `@index/.gitkeep`や`@index/.obsidian/`が存在, **Then** 隠しファイル・フォルダはデフォルトで除外される

---

### Edge Cases

- **空のサブフォルダ**: `@index/empty/`のような空フォルダが存在する場合、エラーにならず処理がスキップされる
- **Markdown以外のファイル**: `@index/images/photo.jpg`などの非Markdownファイルは無視される
- **シンボリックリンク**: シンボリックリンクは安全のためデフォルトで無視される
- **非常に深い階層**: 10階層以上のネストがある場合でも正常に動作する（パフォーマンス考慮）
- **重複ファイル名**: 移動先に同名ファイルが存在する場合、ユーザーに確認を求める

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは`@index/`フォルダ以下のすべてのサブフォルダを再帰的に探索しMarkdownファイル（.md拡張子）を検出する
- **FR-002**: システムは検出したすべてのMarkdownファイルに対して既存の整理処理（ジャンル判定、フォーマット修正、移動）を適用する
- **FR-003**: システムは処理前に対象ファイルの一覧をユーザーに提示し、確認を求める
- **FR-004**: システムは隠しファイル（.で始まる）および隠しフォルダを処理対象から除外する
- **FR-005**: システムは処理完了後、移動したファイル数と移動先の統計情報を表示する
- **FR-006**: システムは処理中にエラーが発生したファイルをスキップし、処理を継続する（エラーログは保持）

### Key Entities

- **対象ファイル (Target File)**: `@index/`以下で検出されたMarkdownファイル。属性：パス、ファイル名、検出ジャンル、処理ステータス
- **除外パターン (Exclusion Pattern)**: 処理対象から除外するフォルダ/ファイルのパターン。デフォルト：隠しファイル、.obsidianフォルダ
- **処理結果 (Processing Result)**: 各ファイルの処理結果。属性：元パス、移動先パス、成功/失敗、エラー詳細

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: `@index/`以下の全Markdownファイルが階層の深さに関係なく100%検出される
- **SC-002**: 処理対象ファイル数が10件以下の場合、ユーザーは1分以内に整理作業を完了できる
- **SC-003**: 処理中のエラー発生時、未処理ファイルの情報が保持され、再実行で処理を継続できる
- **SC-004**: 誤移動を防ぐため、処理前プレビューにより95%以上のユーザーが意図しないファイル移動を防止できる

## Assumptions

- 既存の「整理して」コマンドの基本ロジック（ジャンル判定、フォーマット修正）は変更せず、ファイル検出範囲のみを拡張する
- `@index/claude/`フォルダは「Claude解析」コマンドの出力先だが、手動で追加されたMarkdownファイルは整理対象とする
- パフォーマンス目標：1000ファイルまでのスキャンは30秒以内に完了
- ファイルシステムの権限問題は、読み取り不可ファイルをスキップしてログに記録する対応とする
